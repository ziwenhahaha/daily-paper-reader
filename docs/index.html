<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="UTF-8">
  <title>Daily Paper Reader</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
  <meta name="citation_journal_title" content="Daily Paper Reader (ArXiv)">
  <meta name="citation_title" content="Daily Paper Reader Default Entry">
  <meta name="citation_author" content="Daily Paper Reader Team">
  <meta name="citation_author" content="Docsify Renderer">
  <meta name="citation_date" content="2024/01/01">
  <meta name="citation_pdf_url" content="https://daily-paper-reader.invalid/default.pdf">
  <meta name="citation_volume" content="1">
  <meta name="citation_issue" content="1">
  <meta name="citation_firstpage" content="100">
  <meta name="citation_lastpage" content="110">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/docsify@4/lib/themes/vue.css">
  <!-- KaTeX ç”¨äºå…¬å¼æ¸²æŸ“ -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
  
  <style>
    :root {
      --sidebar-width: 260px;
      --sidebar-min-width: 180px;
      --sidebar-max-width: 480px;
    }

    .katex .katex-mathml {
        display: none !important;
    }
    /* è¯„è®ºåŒºå®¹å™¨ï¼šæœ€å°é«˜åº¦ 200pxï¼Œéšå†…å®¹å¢é•¿ï¼Œæœ€å¤§é«˜åº¦ 660pxï¼Œè¶…å‡ºæ—¶å†…éƒ¨å†å²åŒºæ»šåŠ¨ */
    #paper-chat-container {
      margin-top: 50px;
      padding-top: 20px;
      border-top: 1px solid #eaecef;
      min-height: 200px;       /* å…¬å…±ç ”è®¨åŒºæœ€å°é«˜åº¦ */
      max-height: 660px;       /* å…¬å…±ç ”è®¨åŒºæœ€å¤§é«˜åº¦ */
      display: flex;
      flex-direction: column;  /* è®©å†å²åˆ—è¡¨å’Œè¾“å…¥åŒºæŒ‰åˆ—å¸ƒå±€ */
    }
    .chat-header { font-size: 1.5rem; font-weight: bold; margin-bottom: 20px; }
    
    /* æ¶ˆæ¯åˆ—è¡¨ï¼šå æ®è¯„è®ºåŒºé™¤è¾“å…¥åŒºå¤–çš„ç©ºé—´ï¼Œåªåœ¨å†…éƒ¨æ»šåŠ¨ */
    #chat-history {
      flex: 1 1 auto;
      min-height: 0;           /* é…åˆ flexï¼Œå…è®¸åœ¨å®¹å™¨å†…æ”¶ç¼© */
      overflow-y: auto;        /* åªåœ¨å†å²åŒºå†…éƒ¨æ»šåŠ¨ */
      background: #f9f9f9;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .msg-item { margin-bottom: 12px; }
    .msg-role { font-weight: bold; font-size: 0.9rem; }
    .msg-role.user { color: #42b983; } /* ç”¨æˆ·ç»¿è‰² */
    .msg-role.ai { color: #3b8eed; }   /* AI è“è‰² */
    .msg-content { margin-top: 4px; line-height: 1.6; color: #34495e; white-space: pre-wrap; }
    .msg-content sup { vertical-align: super; font-size: 0.75em; }
    /* å†å²è®°å½•ä¸­çš„æ€è€ƒè¿‡ç¨‹å®¹å™¨æ ·å¼ */
    .thinking-history-container {
      margin-top: 8px;
      border-left: 3px solid #ddd;
      padding-left: 8px;
      font-size: 0.85rem;
      color: #666;
    }
    .thinking-history-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .thinking-history-toggle {
      margin-left: 8px;
      font-size: 0.75rem;
      padding: 2px 6px;
      cursor: pointer;
    }
    .thinking-history-content.thinking-collapsed {
      max-height: 6em; /* çº¦ 3~4 è¡Œ */
      overflow: hidden;
    }
    .msg-time { font-size: 0.8rem; color: #999; margin-left: 10px; }

    /* è¾“å…¥åŒºåŸŸ */
    .input-area { display: flex; gap: 10px; }
    #user-input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      resize: vertical;
    }
    #send-btn {
      padding: 0 20px;
      background: #42b983;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }
    #send-btn:disabled { background: #ccc; cursor: not-allowed; }

    /* è¦†ç›– Docsify ä¸»é¢˜é»˜è®¤çš„ä¸­é—´æ»šåŠ¨å®¹å™¨ï¼Œåªä¿ç•™æœ€å¤–å±‚é¡µé¢æ»šåŠ¨ */
    .content {
      height: auto !important;
      overflow: visible !important;
      left: 0 !important; /* ä¿®å¤Docsifyé»˜è®¤çš„left: 300px */
      margin-left: var(--sidebar-width, 260px) !important;
      padding-left: 0 !important;
      display: flex !important;
      justify-content: center !important; /* è®©markdown-sectionåœ¨contentå†…å±…ä¸­ */
      transition: margin-left 0.3s ease !important; /* æ·»åŠ è¿‡æ¸¡åŠ¨ç”» */
    }

    /* å½“ä¾§è¾¹æ éšè—æ—¶ï¼Œcontentçš„margin-leftå˜ä¸º0 */
    body.close .content {
      margin-left: 0 !important;
    }

    /* éšè—ä¾§è¾¹æ æ—¶ï¼Œä¹Ÿéšè—æ‹–æ‹½å¥æŸ„ */
    body.close #sidebar-resizer {
      display: none !important;
    }

    /* å‡å°‘markdown-sectionçš„é»˜è®¤paddingï¼Œè®©å†…å®¹æ›´å®½ï¼Œå¹¶åœ¨contentå†…å±…ä¸­æ˜¾ç¤º */
    .markdown-section {
      max-width: 1200px !important; /* è®¾ç½®åˆç†çš„æœ€å¤§å®½åº¦ */
      width: 100% !important;
      padding: 30px 60px 40px 60px !important; /* å·¦å³å¯¹ç§°çš„padding */
      margin: 0 auto !important; /* è‡ªåŠ¨å±…ä¸­ */
      box-sizing: border-box !important;
    }
    
    /* ç§»é™¤å¯èƒ½å­˜åœ¨çš„å…¶ä»–å®¹å™¨padding */
    article.markdown-section {
      max-width: 1200px !important;
      width: 100% !important;
      padding: 30px 60px 40px 60px !important;
      margin: 0 auto !important;
      box-sizing: border-box !important;
    }

    /* ä¾§è¾¹æ å®½åº¦å¯è°ƒ */
    .sidebar {
      width: var(--sidebar-width, 260px) !important;
      min-width: var(--sidebar-min-width, 180px);
      max-width: var(--sidebar-max-width, 480px);
    }

    /* ä¾§è¾¹æ æ‹–æ‹½å¥æŸ„ */
    #sidebar-resizer {
      position: fixed;
      top: 0;
      left: calc(var(--sidebar-width, 260px) - 2px);
      width: 4px;
      height: 100vh;
      cursor: col-resize;
      background: transparent;
      z-index: 999;
    }
    #sidebar-resizer::after {
      content: "";
      position: absolute;
      left: 1px;
      top: 0;
      bottom: 0;
      width: 0;
      background: transparent;
    }

    @media (max-width: 768px) {
      #sidebar-resizer {
        display: none;
      }
    }

    /* è‡ªå®šä¹‰æŒ‰é’®æ ·å¼ - ç´§æŒ¨ç€ sidebar-toggleï¼ˆå·¦ä¸‹è§’ï¼‰ */
    .custom-toggle-btn {
      position: fixed;
      bottom: 0;
      left: 46px; /* sidebar-toggle å®½åº¦çº¦ 46pxï¼Œç´§æŒ¨ç€å³è¾¹ */
      width: 46px;
      height: 46px;
      background: #fff;
      border: none;
      border-right: 1px solid rgba(0, 0, 0, 0.07);
      border-top: 1px solid rgba(0, 0, 0, 0.07);
      cursor: pointer;
      z-index: 4;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: background-color 0.3s;
    }
    .custom-toggle-btn:hover {
      background: #f8f8f8;
    }
    @media (max-width: 768px) {
      .custom-toggle-btn {
        display: none;
      }
    }

    /* å·¦ä¸‹è§’è®¢é˜…ç®¡ç†æŒ‰é’® */
    #arxiv-tools {
      position: fixed;
      left: 16px;
      bottom: 20px;
      z-index: 998;
      display: flex;
      gap: 8px;
    }
    .arxiv-tool-btn {
      padding: 6px 10px;
      font-size: 12px;
      border-radius: 4px;
      border: 1px solid #ccc;
      background: #fff;
      cursor: pointer;
      color: #333;
    }
    .arxiv-tool-btn:hover {
      background: #f2f2f2;
    }

    /* Arxiv æœç´¢å…¨å±æµ®å±‚ */
    #arxiv-search-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
    }
    #arxiv-search-panel {
      width: min(720px, 90vw);
      max-height: 85vh;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: flex;
      flex-direction: column;
      padding: 16px;
      overflow-y: auto;  /* åªæ˜¾ç¤ºå‚ç›´æ»šåŠ¨æ¡ */
      overflow-x: hidden;  /* éšè—æ¨ªå‘æ»šåŠ¨æ¡ */
    }
    #arxiv-search-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    #arxiv-search-input {
      width: 100%;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 14px;
      box-sizing: border-box;
    }
    #arxiv-search-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 8px;
      margin-bottom: 8px;
    }
    #arxiv-search-results {
      flex: 0 1 auto;  /* å…è®¸æ”¶ç¼© */
      min-height: 0;
      max-height: 37.5vh;  /* å¢åŠ çº¦1/4é«˜åº¦ */
      overflow-y: auto;
      overflow-x: hidden;  /* éšè—æ¨ªå‘æ»šåŠ¨æ¡ */
      border-top: 1px solid #eee;
      margin-top: 8px;
      padding-top: 8px;
      padding-right: 8px;  /* ç»™å³ä¾§ç•™å‡ºç©ºé—´ */
    }
    /* ç¾åŒ–æ»šåŠ¨æ¡æ ·å¼ - ç²‰è‰²åŒºåŸŸ */
    #arxiv-search-results::-webkit-scrollbar {
      width: 8px;
    }
    #arxiv-search-results::-webkit-scrollbar-track {
      background: #fce4ec;
      border-radius: 4px;
    }
    #arxiv-search-results::-webkit-scrollbar-thumb {
      background: #f8bbd0;
      border-radius: 4px;
    }
    #arxiv-search-results::-webkit-scrollbar-thumb:hover {
      background: #f48fb1;
    }
    
    /* ç¾åŒ–æ»šåŠ¨æ¡æ ·å¼ - ç»¿è‰²åŒºåŸŸï¼ˆå…³é”®è¯ï¼‰ */
    #arxiv-keywords-list::-webkit-scrollbar {
      width: 6px;
    }
    #arxiv-keywords-list::-webkit-scrollbar-track {
      background: #e8f5e9;
      border-radius: 3px;
    }
    #arxiv-keywords-list::-webkit-scrollbar-thumb {
      background: #a5d6a7;
      border-radius: 3px;
    }
    #arxiv-keywords-list::-webkit-scrollbar-thumb:hover {
      background: #81c784;
    }
    
    /* ç¾åŒ–æ»šåŠ¨æ¡æ ·å¼ - è“è‰²åŒºåŸŸï¼ˆZoteroï¼‰ */
    #zotero-list::-webkit-scrollbar {
      width: 6px;
    }
    #zotero-list::-webkit-scrollbar-track {
      background: #e3f2fd;
      border-radius: 3px;
    }
    #zotero-list::-webkit-scrollbar-thumb {
      background: #90caf9;
      border-radius: 3px;
    }
    #zotero-list::-webkit-scrollbar-thumb:hover {
      background: #64b5f6;
    }
    
    /* ç¾åŒ–æ»šåŠ¨æ¡æ ·å¼ - è·Ÿè¸ªè®ºæ–‡åˆ—è¡¨ */
    #arxiv-tracked-list::-webkit-scrollbar {
      width: 6px;
    }
    #arxiv-tracked-list::-webkit-scrollbar-track {
      background: #fce4ec;
      border-radius: 3px;
    }
    #arxiv-tracked-list::-webkit-scrollbar-thumb {
      background: #f8bbd0;
      border-radius: 3px;
    }
    #arxiv-tracked-list::-webkit-scrollbar-thumb:hover {
      background: #f48fb1;
    }
    
    /* ç¾åŒ–æ»šåŠ¨æ¡æ ·å¼ - æ¨¡æ€æ¡†æ•´ä½“ */
    #arxiv-search-panel::-webkit-scrollbar {
      width: 10px;
    }
    #arxiv-search-panel::-webkit-scrollbar-track {
      background: #f5f5f5;
      border-radius: 5px;
    }
    #arxiv-search-panel::-webkit-scrollbar-thumb {
      background: #bdbdbd;
      border-radius: 5px;
    }
    #arxiv-search-panel::-webkit-scrollbar-thumb:hover {
      background: #9e9e9e;
    }
    
    #arxiv-subscriptions {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 12px;
      flex-shrink: 0;  /* é˜²æ­¢è¢«å‹ç¼© */
    }
    #arxiv-top-row {
      display: flex;
      gap: 6px;  /* å‡å°gapé¿å…å®½åº¦æº¢å‡º */
    }
    .arxiv-pane {
      padding: 8px;
      border-radius: 6px;
      box-sizing: border-box;
    }
    #arxiv-keywords-pane {
      flex: 1 1 0;           /* ä½¿ç”¨flex-growç¡®ä¿å¹³åˆ† */
      min-width: 0;          /* é˜²æ­¢å†…å®¹æ’‘å¼€ */
      box-sizing: border-box;
      background: #e8f5e9;   /* æ·¡ç»¿è‰² */
    }
    #arxiv-zotero-pane {
      flex: 1 1 0;           /* ä½¿ç”¨flex-growç¡®ä¿å¹³åˆ† */
      min-width: 0;          /* é˜²æ­¢å†…å®¹æ’‘å¼€ */
      box-sizing: border-box;
      background: #e3f2fd;   /* æ·¡è“è‰² */
    }
    #arxiv-search-section {
      margin-top: 8px;
      background: #fce4ec; /* æ·¡ç²‰è‰² */
    }
    .arxiv-result-item {
      padding: 6px 8px;
      margin: 0 0 4px 0;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: all 0.2s;
      border-radius: 4px;
    }
    .arxiv-result-item:hover {
      background-color: #fdd5e3;
      border-radius: 4px;
    }
    .arxiv-result-item.selected {
      background-color: #f8bbd0;
      border-left: 3px solid #ec407a;
      padding-left: 5px;
      border-radius: 4px;
    }
    .arxiv-tracked-item {
      padding: 6px 8px;
      margin: 0 -8px;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      align-items: flex-start;
      gap: 8px;
      border-radius: 4px;
    }
    .tag-label {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
      margin-right: 6px;
      white-space: nowrap;
    }
    .tag-green {
      background-color: #e8f5e9;
      color: #2e7d32;
    }
    .tag-blue {
      background-color: #e3f2fd;
      color: #1565c0;
    }
    .tag-pink {
      background-color: #fce4ec;
      color: #c2185b;
    }
    .arxiv-result-meta {
      flex: 1;
      min-width: 0;
    }
    .arxiv-result-action-area {
      display: flex;
      gap: 4px;
      align-items: center;
      flex-shrink: 0;
      margin-left: auto;
    }
    .arxiv-result-action-area input {
      width: 120px;
      padding: 4px 6px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 11px;
    }
    .arxiv-result-action-area button {
      padding: 4px 10px;
      font-size: 11px;
      white-space: nowrap;
    }
    .arxiv-result-title {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 2px;
    }
    .arxiv-result-authors,
    .arxiv-result-published {
      font-size: 12px;
      color: #666;
    }
    #arxiv-search-message {
      font-size: 12px;
      color: #999;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div id="app">åŠ è½½ä¸­...</div>

  <script>
    window.$docsify = {
      name: 'Daily Paper Reader',
      repo: '',
      loadSidebar: true, // å¼€å¯ä¾§è¾¹æ 
      subMaxLevel: 2,
      
      // --- æ ¸å¿ƒï¼šæ³¨å†Œè‡ªå®šä¹‰æ’ä»¶ ---
      plugins: [
        function(hook, vm) {
          // ç¡®ä¿ marked å¼€å¯ GFM è¡¨æ ¼æ”¯æŒï¼Œå¹¶å…è®¸å†…è” HTMLï¼ˆç”¨äºèŠå¤©åŒº Markdown æ¸²æŸ“ï¼‰
          if (window.marked && window.marked.setOptions) {
            const baseOptions = (window.marked.getDefaults && window.marked.getDefaults()) || {};
            window.marked.setOptions(Object.assign({}, baseOptions, {
              gfm: true,
              breaks: false,
              tables: true,
              // å…è®¸ <sup> ç­‰å†…è” HTML ç›´æ¥æ¸²æŸ“ï¼Œè€Œä¸æ˜¯è¢«è½¬ä¹‰
              sanitize: false,
              mangle: false,
              headerIds: false,
            }));
          }

          // 1. è§£æå½“å‰æ–‡ç«  ID (ç®€å•ç”¨æ–‡ä»¶åä½œä¸º ID)
          const getPaperId = () => {
            return vm.route.file.replace('.md', ''); 
          };

          const metaFallbacks = {
            citation_title: 'Daily Paper Reader Default Entry',
            citation_journal_title: 'Daily Paper Reader (ArXiv)',
            citation_pdf_url: 'https://daily-paper-reader.invalid/default.pdf',
            citation_publication_date: '2024-01-01',
            citation_date: '2024/01/01'
          };

          const defaultAuthors = ['Daily Paper Reader Team', 'Docsify Renderer'];

          // å…¬å…±å·¥å…·ï¼šåœ¨æŒ‡å®šå…ƒç´ ä¸Šæ¸²æŸ“å…¬å¼
          const renderMathInEl = (el) => {
            if (!window.renderMathInElement || !el) return;
            window.renderMathInElement(el, {
              delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
              ],
              throwOnError: false,
            });
          };

          // å…¬å…±å·¥å…·ï¼šç®€å•è¡¨æ ¼ + æ ‡è®°ä¿®æ­£ï¼š
          // 1ï¼‰ç§»é™¤åè®®æ ‡è®° [ANS]/[THINK]
          // 2ï¼‰ç§»é™¤è¡¨æ ¼è¡Œä¹‹é—´å¤šä½™ç©ºè¡Œï¼Œé¿å…æŠŠåŒä¸€å¼ è¡¨æ‹†æˆä¸¤å—
          const normalizeTables = (markdown) => {
            if (!markdown) return '';
            // æ¸…ç†å†å²é—ç•™çš„åè®®æ ‡è®°
            let text = markdown.replace(/\[ANS\]/g, '').replace(/\[THINK\]/g, '');

            const lines = text.split('\n');
            const isTableLine = (line) => /^\s*\|.*\|\s*$/.test(line);
            const result = [];
            for (let i = 0; i < lines.length; i++) {
              const line = lines[i];
              const prev = result.length ? result[result.length - 1] : '';
              const next = i + 1 < lines.length ? lines[i + 1] : '';
              if (
                line.trim() === '' &&
                isTableLine(prev || '') &&
                isTableLine(next || '')
              ) {
                // è·³è¿‡è¡¨æ ¼è¡Œä¹‹é—´çš„ç©ºè¡Œ
                continue;
              }
              result.push(line);
            }
            return result.join('\n');
          };

          const escapeHtml = (str) => {
            return str
              .replace(/&/g, '&amp;')
              .replace(/</g, '&lt;')
              .replace(/>/g, '&gt;')
              .replace(/"/g, '&quot;')
              .replace(/'/g, '&#39;');
          };

          // è‡ªå®šä¹‰è¡¨æ ¼æ¸²æŸ“ï¼šæ£€æµ‹ Markdown è¡¨æ ¼å—å¹¶æ‰‹å†™ç”Ÿæˆ <table>ï¼Œ
          // å…¶ä»–å†…å®¹ä»äº¤ç»™ marked æ¸²æŸ“ã€‚
          const renderMarkdownWithTables = (markdown) => {
            const text = normalizeTables(markdown || '');
            const lines = text.split('\n');
            const isTableLine = (line) => /^\s*\|.*\|\s*$/.test(line);
            const isAlignLine = (line) => /^\s*\|(?:\s*:?-+:?\s*\|)+\s*$/.test(line);

            const parseRow = (line) => {
              const trimmed = line.trim().replace(/^\|/, '').replace(/\|$/, '');
              return trimmed.split('|').map((cell) => cell.trim());
            };

            const inlineRender = (cellText) => {
              if (!cellText) return '';
              if (window.marked && window.marked.parseInline) {
                return window.marked.parseInline(cellText);
              }
              return escapeHtml(cellText);
            };

            const blocks = [];
            let i = 0;

            const flushParagraph = (paraLines) => {
              const paraText = paraLines.join('\n').trim();
              if (!paraText) return;
              if (window.marked) {
                blocks.push(window.marked.parse(`\n${paraText}\n`));
              } else {
                blocks.push(`<p>${escapeHtml(paraText)}</p>`);
              }
            };

            while (i < lines.length) {
              const line = lines[i];

              // æ£€æµ‹è¡¨æ ¼å—ï¼šå½“å‰è¡Œæ˜¯è¡¨æ ¼è¡Œï¼Œä¸‹ä¸€è¡Œæ˜¯å¯¹é½è¡Œ
              if (isTableLine(line) && i + 1 < lines.length && isAlignLine(lines[i + 1])) {
                // å…ˆæŠŠå‰é¢çš„æ®µè½åˆ·æ‰
                // ï¼ˆé€šè¿‡ä¸æ–­æ”¶é›†éè¡¨æ ¼è¡Œå®ç°ï¼Œè¿™é‡Œå‡å®šæ²¡æœ‰å‰ç¼€æœªåˆ·æ®µè½ï¼‰

                const headerLine = lines[i];
                const alignLine = lines[i + 1]; // ç›®å‰æœªä½¿ç”¨ï¼Œä»…ç”¨æ¥æ£€æµ‹
                i += 2;

                const bodyLines = [];
                while (i < lines.length && isTableLine(lines[i])) {
                  bodyLines.push(lines[i]);
                  i++;
                }

                const headers = parseRow(headerLine);
                const rows = bodyLines.map(parseRow);

                let html = '<table class="chat-table"><thead><tr>';
                headers.forEach((h) => {
                  html += `<th>${inlineRender(h)}</th>`;
                });
                html += '</tr></thead><tbody>';
                rows.forEach((row) => {
                  html += '<tr>';
                  row.forEach((cell) => {
                    html += `<td>${inlineRender(cell)}</td>`;
                  });
                  html += '</tr>';
                });
                html += '</tbody></table>';

                blocks.push(html);
              } else {
                // éè¡¨æ ¼å—ï¼šæ”¶é›†åˆ°ä¸‹ä¸€ä¸ªè¡¨æ ¼æˆ–ç»“å°¾
                const paraLines = [];
                while (
                  i < lines.length &&
                  !(isTableLine(lines[i]) && i + 1 < lines.length && isAlignLine(lines[i + 1]))
                ) {
                  paraLines.push(lines[i]);
                  i++;
                }
                flushParagraph(paraLines);
              }
            }

            return blocks.join('');
          };

          const updateMetaTag = (name, content, options = {}) => {
            const old = document.querySelector(`meta[name="${name}"]`);
            if (old) old.remove();
            const useFallback = options.useFallback !== false;
            const value = content || (useFallback ? metaFallbacks[name] : '');
            if (!value) return;
            const meta = document.createElement('meta');
            meta.name = name;
            meta.content = value;
            document.head.appendChild(meta);
          };

          // 2. æ¸²æŸ“è¯„è®ºåŒºçš„ HTML ç»“æ„
          const renderChatUI = () => {
            return `
              <div id="paper-chat-container">
                <div class="chat-header">ğŸ’¬ å…¬å…±ç ”è®¨åŒº (Public Discussion)</div>
                <div id="chat-history">
                    <div style="text-align:center; color:#999">æ­£åœ¨åŠ è½½è®¨è®ºè®°å½•...</div>
                </div>
                <div class="input-area">
                  <textarea id="user-input" rows="3" placeholder="é’ˆå¯¹è¿™ç¯‡è®ºæ–‡æé—®ï¼Œæ‰€æœ‰äººå¯è§..."></textarea>
                  <button id="send-btn">å‘é€</button>
                </div>
              </div>
            `;
          };

          // 3. è·å–å†å²è®°å½• (API)
          const loadHistory = async (paperId) => {
            try {
              const res = await fetch(`/api/history?paper_id=${encodeURIComponent(paperId)}`);
              const data = await res.json();

              const historyDiv = document.getElementById('chat-history');
              if (!data || !data.length) {
                historyDiv.innerHTML = '<div style="text-align:center; color:#999">æš‚æ— è®¨è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘ï¼</div>';
                return;
              }

              historyDiv.innerHTML = '';
              data.forEach(msg => {
                const item = document.createElement('div');
                item.className = 'msg-item';

                const header = document.createElement('div');
                const roleSpan = document.createElement('span');
                const isThinking = msg.role === 'thinking';
                const isAi = msg.role === 'ai' || isThinking;
                roleSpan.className = 'msg-role ' + (isAi ? 'ai' : 'user');
                roleSpan.textContent = isThinking
                  ? 'ğŸ§  AI æ€è€ƒè¿‡ç¨‹'
                  : (msg.role === 'ai' ? 'ğŸ¤– AI åŠ©æ‰‹' : 'ğŸ‘¤ å­¦æœ¯è·¯äºº');
                const timeSpan = document.createElement('span');
                timeSpan.className = 'msg-time';
                timeSpan.textContent = msg.time || '';
                header.appendChild(roleSpan);
                header.appendChild(timeSpan);

                if (!isThinking) {
                  const contentDiv = document.createElement('div');
                  contentDiv.className = 'msg-content';
                  const markdown = msg.content || '';
                  contentDiv.innerHTML = renderMarkdownWithTables(markdown);
                  renderMathInEl(contentDiv);

                  item.appendChild(header);
                  item.appendChild(contentDiv);
                  historyDiv.appendChild(item);
                  return;
                }

                // æ€è€ƒæ¶ˆæ¯ï¼šæ¸²æŸ“ä¸ºå¯æŠ˜å çš„å†å²æ€è€ƒåŒºåŸŸ
                const thinkingContainer = document.createElement('div');
                thinkingContainer.className = 'thinking-history-container';

                const thinkingHeader = document.createElement('div');
                thinkingHeader.className = 'thinking-history-header';
                const titleSpan = document.createElement('span');
                titleSpan.textContent = 'æ€è€ƒè¿‡ç¨‹';
                const toggleBtn = document.createElement('button');
                toggleBtn.className = 'thinking-history-toggle';
                toggleBtn.textContent = 'å±•å¼€';
                thinkingHeader.appendChild(titleSpan);
                thinkingHeader.appendChild(toggleBtn);

                const thinkingContent = document.createElement('div');
                thinkingContent.className = 'msg-content thinking-history-content thinking-collapsed';
                const markdown = msg.content || '';
                thinkingContent.innerHTML = renderMarkdownWithTables(markdown);
                renderMathInEl(thinkingContent);

                thinkingContainer.appendChild(thinkingHeader);
                thinkingContainer.appendChild(thinkingContent);

                // é»˜è®¤æŠ˜å ï¼Œç‚¹å‡»æŒ‰é’®å±•å¼€/æŠ˜å 
                toggleBtn.addEventListener('click', () => {
                  const collapsed = thinkingContent.classList.toggle('thinking-collapsed');
                  toggleBtn.textContent = collapsed ? 'å±•å¼€' : 'æŠ˜å ';
                });

                item.appendChild(header);
                item.appendChild(thinkingContainer);
                historyDiv.appendChild(item);
              });

              historyDiv.scrollTop = historyDiv.scrollHeight;

            } catch (e) {
              console.error("åŠ è½½å¤±è´¥", e);
            }
          };

          // Arxiv æœç´¢ UIï¼šåˆ›å»ºå·¦ä¸‹è§’æŒ‰é’®å’Œæµ®å±‚
          const ensureArxivSearchUI = () => {
            if (!document.getElementById('arxiv-tools')) {
              const tools = document.createElement('div');
              tools.id = 'arxiv-tools';
              tools.innerHTML = `
                <button class="arxiv-tool-btn" id="arxiv-search-open-btn">è®¢é˜…ç®¡ç†</button>
              `;
              document.body.appendChild(tools);
            }

            if (!document.getElementById('arxiv-search-overlay')) {
              const overlay = document.createElement('div');
              overlay.id = 'arxiv-search-overlay';
              overlay.innerHTML = `
                <div id="arxiv-search-panel">
                  <div id="arxiv-search-panel-header">
                    <div style="font-weight:600;">è®¢é˜…ç®¡ç†ï¼ˆå…³é”®è¯ + è®ºæ–‡ï¼‰</div>
                    <button id="arxiv-search-close-btn" class="arxiv-tool-btn" style="padding:2px 6px;">å…³é—­</button>
                  </div>
                  <div id="arxiv-subscriptions">
                    <div id="arxiv-top-row">
                      <div id="arxiv-keywords-pane" class="arxiv-pane">
                        <div style="font-weight:500; margin-bottom:4px;">è®¢é˜…å…³é”®è¯</div>
                        <div id="arxiv-keywords-list" style="font-size:12px; height:120px; overflow-y:auto; border:1px solid #eee; padding:6px; border-radius:4px; background:#fff; margin-bottom:4px;"></div>
                        <div style="display:flex; gap:4px; margin-bottom:4px; align-items:center; max-width:100%;">
                          <input id="arxiv-keyword-input" type="text"
                            placeholder="æ–°å¢å…³é”®è¯ï¼Œå¦‚ llm"
                            style="flex:3 1 0; min-width:0; padding:6px; border-radius:4px; border:1px solid #ccc; font-size:12px;"
                          />
                          <input id="arxiv-keyword-alias-input" type="text"
                            placeholder="å¤‡æ³¨ï¼ˆå¿…å¡«ï¼‰"
                            required
                            style="flex:2 1 0; min-width:0; padding:6px; border-radius:4px; border:1px solid #ccc; font-size:12px;"
                          />
                          <button id="arxiv-keyword-add-btn" class="arxiv-tool-btn"
                            style="flex:1 1 0; min-width:0; white-space:nowrap; padding:6px 4px; font-size:12px;">æ–°å¢</button>
                        </div>
                      </div>

                      <div id="arxiv-zotero-pane" class="arxiv-pane">
                        <div style="font-weight:500; margin-bottom:4px;">è®¢é˜…Zotero</div>
                        <div id="zotero-list" style="font-size:12px; height:88px; overflow-y:auto; border:1px solid #eee; padding:6px; border-radius:4px; background:#fff; margin-bottom:4px;"></div>
                        <!-- ç¬¬ä¸€è¡Œï¼šç”¨æˆ·ID å’Œ API Key (1:3) -->
                        <div style="display:flex; gap:4px; margin-bottom:4px; max-width:100%;">
                          <input id="zotero-id-input" type="text"
                            placeholder="ç”¨æˆ·ID"
                            style="flex:1 1 0; min-width:0; padding:6px; border-radius:4px; border:1px solid #ccc; font-size:12px;"
                          />
                          <input id="zotero-key-input" type="text"
                            placeholder="API Key"
                            style="flex:3 1 0; min-width:0; padding:6px; border-radius:4px; border:1px solid #ccc; font-size:12px;"
                          />
                        </div>
                        <!-- ç¬¬äºŒè¡Œï¼šç¼©å†™ã€æµ‹è¯•æŒ‰é’®ã€æ–°å¢æŒ‰é’® -->
                        <div style="display:flex; gap:4px; margin-bottom:4px; max-width:100%;">
                          <input id="zotero-alias-input" type="text"
                            placeholder="å¤‡æ³¨ï¼ˆå¿…å¡«ï¼‰"
                            required
                            style="flex:1 1 0; min-width:0; padding:6px; border-radius:4px; border:1px solid #ccc; font-size:12px;"
                          />
                          <button id="zotero-test-btn" class="arxiv-tool-btn" style="flex:0 0 auto; padding:6px 8px; font-size:12px; white-space:nowrap;">æµ‹è¯•</button>
                          <button id="zotero-add-btn" class="arxiv-tool-btn" style="flex:0 0 auto; padding:6px 8px; font-size:12px; white-space:nowrap;">æ–°å¢</button>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div id="arxiv-search-section" class="arxiv-pane">
                    <div style="font-weight:500; margin-bottom:4px;">è®¢é˜…è®ºæ–‡æ–°å¼•ç”¨</div>
                    <div id="arxiv-tracked-list" style="font-size:12px; max-height:120px; overflow-y:auto; overflow-x:hidden; border:1px solid #eee; padding:6px; border-radius:4px; background:#fff; margin-bottom:8px;"></div>

                    <div style="font-weight:500; margin-bottom:4px;">é€šè¿‡ Arxiv æœç´¢æ–°å¢éœ€è·Ÿè¸ªçš„è®ºæ–‡</div>
                    <div style="display:flex; gap:4px; margin-bottom:4px; max-width:100%;">
                      <input id="arxiv-search-input" type="text"
                        placeholder="arxiv é“¾æ¥æˆ–è®ºæ–‡æ ‡é¢˜/å…³é”®è¯"
                        style="flex:1; min-width:0; padding:6px; border-radius:4px; border:1px solid #ccc; font-size:12px;"
                      />
                      <button id="arxiv-search-btn" class="arxiv-tool-btn" style="padding:6px 12px; font-size:12px; white-space:nowrap;">æœç´¢</button>
                    </div>
                    <div id="arxiv-search-message"></div>
                    <div id="arxiv-search-results"></div>
                  </div>
                </div>
              `;
              document.body.appendChild(overlay);
            }

            // ç»‘å®šäº‹ä»¶ï¼ˆå¹‚ç­‰ï¼‰
            const openBtn = document.getElementById('arxiv-search-open-btn');
            const overlay = document.getElementById('arxiv-search-overlay');
            const closeBtn = document.getElementById('arxiv-search-close-btn');
            const input = document.getElementById('arxiv-search-input');
            const searchBtn = document.getElementById('arxiv-search-btn');
            const msgEl = document.getElementById('arxiv-search-message');
            const resultsEl = document.getElementById('arxiv-search-results');
            const keywordsListEl = document.getElementById('arxiv-keywords-list');
            const trackedListEl = document.getElementById('arxiv-tracked-list');
            const keywordInput = document.getElementById('arxiv-keyword-input');
            const keywordAddBtn = document.getElementById('arxiv-keyword-add-btn');
            const keywordAliasInput = document.getElementById('arxiv-keyword-alias-input');
            const zoteroListEl = document.getElementById('zotero-list');
            const zoteroIdInput = document.getElementById('zotero-id-input');
            const zoteroKeyInput = document.getElementById('zotero-key-input');
            const zoteroAliasInput = document.getElementById('zotero-alias-input');
            const zoteroAddBtn = document.getElementById('zotero-add-btn');

            let lastSearchTs = 0;

            const renderKeywords = (items) => {
              if (!keywordsListEl) return;
              if (!items || !items.length) {
                keywordsListEl.innerHTML = '<div style="color:#999;">æš‚æ— å…³é”®è¯è®¢é˜…ï¼Œå¯åœ¨ä¸‹æ–¹æ–°å¢ã€‚</div>';
                return;
              }
              keywordsListEl.innerHTML = '';
              items.forEach((item) => {
                const row = document.createElement('div');
                row.style.display = 'flex';
                row.style.alignItems = 'center';
                row.style.justifyContent = 'space-between';
                row.style.marginBottom = '2px';
                const alias = item.alias || '';
                row.innerHTML = `
                  <span>${alias ? '<span class="tag-label tag-green">' + escapeHtml(alias) + '</span>' : ''}${escapeHtml(item.keyword || '')}</span>
                  <button data-id="${item.id}" class="arxiv-keyword-del" style="border:none;background:none;color:#c00;font-size:11px;cursor:pointer;">åˆ é™¤</button>
                `;
                keywordsListEl.appendChild(row);
              });
              keywordsListEl.querySelectorAll('.arxiv-keyword-del').forEach((btn) => {
                btn.addEventListener('click', async (e) => {
                  const id = btn.getAttribute('data-id');
                  if (!id) return;
                  try {
                    await fetch(`/api/subscriptions/keyword/${id}`, { method: 'DELETE' });
                    loadSubscriptions();
                  } catch (err) {
                    console.error(err);
                  }
                });
              });
            };

            const renderTracked = (items) => {
              if (!trackedListEl) return;
              if (!items || !items.length) {
                trackedListEl.innerHTML = '<div style="color:#999;">æš‚æ— è®¢é˜…è®ºæ–‡ï¼Œå¯é€šè¿‡ä¸‹æ–¹æœç´¢æ·»åŠ ã€‚</div>';
                return;
              }
              trackedListEl.innerHTML = '';
              items.forEach((item) => {
                const row = document.createElement('div');
                row.className = 'arxiv-tracked-item';
                const allAuthors = item.authors || [];
                const displayAuthors = allAuthors.slice(0, 5).join(', ') + (allAuthors.length > 5 ? ', ...' : '');
                const alias = item.alias || '';
                row.innerHTML = `
                  <div style="flex:1; min-width:0;">
                    <div style="font-size:14px; font-weight:500; margin-bottom:2px;">${alias ? '<span class="tag-label tag-pink">' + escapeHtml(alias) + '</span>' : ''}${escapeHtml(item.title || '')}</div>
                    <div style="font-size:12px;color:#666;">${displayAuthors ? escapeHtml(displayAuthors) : ''}</div>
                    <div style="font-size:12px;color:#666;">
                      ${item.published ? 'å‘è¡¨äºï¼š' + escapeHtml(item.published) : ''}
                      ${item.arxiv_id ? (item.published ? ' ï½œ ' : '') + 'arXiv: ' + escapeHtml(item.arxiv_id) : ''}
                    </div>
                  </div>
                  <button data-id="${item.id}" class="arxiv-tracked-del" style="flex-shrink:0;border:none;background:none;color:#c00;font-size:11px;cursor:pointer;padding:2px 4px;">å–æ¶ˆè®¢é˜…</button>
                `;
                trackedListEl.appendChild(row);
              });
              trackedListEl.querySelectorAll('.arxiv-tracked-del').forEach((btn) => {
                btn.addEventListener('click', async () => {
                  const id = btn.getAttribute('data-id');
                  if (!id) return;
                  try {
                    await fetch(`/api/arxiv_track/${id}`, { method: 'DELETE' });
                    loadSubscriptions();
                  } catch (err) {
                    console.error(err);
                  }
                });
              });
            };

            const loadSubscriptions = async () => {
              try {
                const res = await fetch('/api/subscriptions');
                if (!res.ok) return;
                const data = await res.json();
                renderKeywords(data.keywords || []);
                renderTracked(data.tracked_papers || []);
                renderZotero(data.zotero_accounts || []);
              } catch (e) {
                console.error(e);
              }
            };

            const openOverlay = () => {
              overlay.style.display = 'flex';
              msgEl.textContent = 'æç¤ºï¼š3 ç§’å†…åªèƒ½æœç´¢ä¸€æ¬¡';
              resultsEl.innerHTML = '';
              loadSubscriptions();
              setTimeout(() => input.focus(), 50);
            };

            const closeOverlay = () => {
              overlay.style.display = 'none';
            };

            const renderResults = (items) => {
              if (!items || !items.length) {
                resultsEl.innerHTML = '<div style="font-size:12px; color:#999;">æœªæ‰¾åˆ°ç›¸å…³ç»“æœï¼Œè¯·å°è¯•ä¿®æ”¹å…³é”®è¯ã€‚</div>';
                return;
              }
              resultsEl.innerHTML = '';
              items.forEach((item, idx) => {
                const row = document.createElement('div');
                row.className = 'arxiv-result-item';
                if (idx === 0) row.classList.add('selected');
                const allAuthors = item.authors || [];
                const displayAuthors = allAuthors.slice(0, 5).join(', ') + (allAuthors.length > 5 ? ', ...' : '');
                row.innerHTML = `
                  <input type="radio" name="arxiv-choice" value="${item.arxiv_id}" ${idx === 0 ? 'checked' : ''} style="pointer-events:none; flex-shrink:0;" />
                  <div class="arxiv-result-meta">
                    <div class="arxiv-result-title">${escapeHtml(item.title || '')}</div>
                    <div class="arxiv-result-authors">${displayAuthors ? escapeHtml(displayAuthors) : ''}</div>
                    <div class="arxiv-result-published">
                      ${item.published ? 'å‘è¡¨äºï¼š' + escapeHtml(item.published) : ''}
                      ${item.arxiv_id ? (item.published ? ' ï½œ ' : '') + 'arXiv: ' + escapeHtml(item.arxiv_id) : ''}
                    </div>
                  </div>
                `;
                
                // å¦‚æœæ˜¯ç¬¬ä¸€é¡¹ï¼ˆé»˜è®¤é€‰ä¸­ï¼‰ï¼Œæ·»åŠ æ“ä½œåŒº
                if (idx === 0) {
                  const actionDiv = document.createElement('div');
                  actionDiv.className = 'arxiv-result-action-area';
                  actionDiv.innerHTML = `
                    <input type="text" class="arxiv-track-alias-input" placeholder="å¤‡æ³¨" required />
                    <button class="arxiv-track-btn arxiv-tool-btn">åŠ å…¥åå°</button>
                  `;
                  row.appendChild(actionDiv);
                }
                
                // ç‚¹å‡»æ•´è¡Œé€‰ä¸­
                row.addEventListener('click', (e) => {
                  // å¦‚æœç‚¹å‡»çš„æ˜¯è¾“å…¥æ¡†æˆ–æŒ‰é’®ï¼Œä¸å¤„ç†
                  if (e.target.tagName === 'INPUT' && e.target.type === 'text') return;
                  if (e.target.tagName === 'BUTTON') return;
                  
                  // ç§»é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€å’Œæ“ä½œåŒº
                  resultsEl.querySelectorAll('.arxiv-result-item').forEach(r => {
                    r.classList.remove('selected');
                    const actionArea = r.querySelector('.arxiv-result-action-area');
                    if (actionArea) actionArea.remove();
                  });
                  
                  // æ·»åŠ å½“å‰é€‰ä¸­çŠ¶æ€
                  row.classList.add('selected');
                  const radio = row.querySelector('input[type="radio"]');
                  if (radio) radio.checked = true;
                  
                  // æ·»åŠ æ“ä½œåŒº
                  const actionDiv = document.createElement('div');
                  actionDiv.className = 'arxiv-result-action-area';
                  actionDiv.innerHTML = `
                    <input type="text" class="arxiv-track-alias-input" placeholder="å¤‡æ³¨" required />
                    <button class="arxiv-track-btn arxiv-tool-btn">åŠ å…¥åå°</button>
                  `;
                  row.appendChild(actionDiv);
                  
                  // ç»‘å®šæ–°æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
                  const trackBtn = actionDiv.querySelector('.arxiv-track-btn');
                  trackBtn.addEventListener('click', () => doTrack());
                });
                
                // å¦‚æœæ˜¯ç¬¬ä¸€é¡¹ï¼Œç»‘å®šæŒ‰é’®äº‹ä»¶
                if (idx === 0) {
                  const trackBtn = row.querySelector('.arxiv-track-btn');
                  if (trackBtn) {
                    trackBtn.addEventListener('click', () => doTrack());
                  }
                }
                
                resultsEl.appendChild(row);
              });
            };

            const doSearch = async () => {
              const now = Date.now();
              if (now - lastSearchTs < 3000) {
                msgEl.textContent = 'æœç´¢è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•ï¼ˆ3 ç§’å†…åªèƒ½æœç´¢ä¸€æ¬¡ï¼‰';
                return;
              }
              const q = (input.value || '').trim();
              if (!q) {
                msgEl.textContent = 'è¯·è¾“å…¥å…³é”®è¯æˆ– arxiv é“¾æ¥';
                return;
              }
              lastSearchTs = now;
              msgEl.textContent = 'æœç´¢ä¸­...';
              resultsEl.innerHTML = '';

              try {
                const res = await fetch(`/api/arxiv_search?query=${encodeURIComponent(q)}`);
                if (!res.ok) {
                  const data = await res.json().catch(() => ({}));
                  msgEl.textContent = data.detail || 'æœç´¢å¤±è´¥';
                  return;
                }
                const data = await res.json();
                renderResults(data.items || []);
                msgEl.textContent = 'æœç´¢å®Œæˆï¼Œå¯é€‰æ‹©ä¸€ç¯‡è®ºæ–‡å¹¶ç‚¹å‡»ã€ŒåŠ å…¥åå°ã€';
                
                // å¹³æ»‘æ»šåŠ¨æ¨¡æ€æ¡†åˆ°åº•éƒ¨ï¼Œæ˜¾ç¤ºæœç´¢ç»“æœ
                const panel = document.getElementById('arxiv-search-panel');
                if (panel) {
                  setTimeout(() => {
                    panel.scrollTo({
                      top: panel.scrollHeight,
                      behavior: 'smooth'
                    });
                  }, 100);
                }
              } catch (e) {
                console.error(e);
                msgEl.textContent = 'æœç´¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
              }
            };

            const addKeyword = async () => {
              const kw = (keywordInput.value || '').trim();
              const alias = (keywordAliasInput.value || '').trim();
              if (!kw) {
                msgEl.textContent = 'æ–°å¢å…³é”®è¯ä¸èƒ½ä¸ºç©º';
                return;
              }
              if (!alias) {
                msgEl.textContent = 'å¤‡æ³¨ä¸ºå¿…å¡«é¡¹';
                return;
              }
              try {
                const res = await fetch('/api/subscriptions/keyword', {
                  method: 'POST',
                  headers: {'Content-Type': 'application/json'},
                  body: JSON.stringify({ keyword: kw, alias }),
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) {
                  msgEl.textContent = data.detail || 'æ–°å¢å…³é”®è¯å¤±è´¥';
                } else {
                  keywordInput.value = '';
                  keywordAliasInput.value = '';
                  msgEl.textContent = 'å…³é”®è¯å·²æ–°å¢ã€‚';
                  loadSubscriptions();
                }
              } catch (e) {
                console.error(e);
                msgEl.textContent = 'æ–°å¢å…³é”®è¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
              }
            };

            const renderZotero = (items) => {
              if (!zoteroListEl) return;
              if (!items || !items.length) {
                zoteroListEl.innerHTML = '<div style="color:#999;">æš‚æ—  Zotero é›†æˆï¼Œå¯åœ¨ä¸‹æ–¹æ–°å¢ã€‚</div>';
                return;
              }
              zoteroListEl.innerHTML = '';
              items.forEach((item) => {
                const row = document.createElement('div');
                row.style.display = 'flex';
                row.style.alignItems = 'center';
                row.style.justifyContent = 'space-between';
                row.style.marginBottom = '2px';
                row.innerHTML = `
                  <span style="font-size:12px;">${item.alias ? '<span class="tag-label tag-blue">' + escapeHtml(item.alias) + '</span>' : ''} ID: ${escapeHtml(item.zotero_id || '')}</span>
                  <button data-id="${item.id}" class="zotero-del-btn" style="border:none;background:none;color:#c00;font-size:11px;cursor:pointer;">åˆ é™¤</button>
                `;
                zoteroListEl.appendChild(row);
              });
              zoteroListEl.querySelectorAll('.zotero-del-btn').forEach((btn) => {
                btn.addEventListener('click', async () => {
                  const id = btn.getAttribute('data-id');
                  if (!id) return;
                  try {
                    await fetch(`/api/subscriptions/zotero/${id}`, { method: 'DELETE' });
                    loadSubscriptions();
                  } catch (err) {
                    console.error(err);
                  }
                });
              });
            };

            const addZotero = async () => {
              const zid = (zoteroIdInput.value || '').trim();
              const key = (zoteroKeyInput.value || '').trim();
              const alias = (zoteroAliasInput.value || '').trim();
              if (!zid || !key) {
                msgEl.textContent = 'Zotero ID å’Œ Key ä¸èƒ½ä¸ºç©º';
                return;
              }
              if (!alias) {
                msgEl.textContent = 'å¤‡æ³¨ä¸ºå¿…å¡«é¡¹';
                return;
              }
              try {
                const res = await fetch('/api/subscriptions/zotero', {
                  method: 'POST',
                  headers: {'Content-Type': 'application/json'},
                  body: JSON.stringify({ zotero_id: zid, api_key: key, alias }),
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) {
                  msgEl.textContent = data.detail || 'æ–°å¢ Zotero å¤±è´¥';
                } else {
                  msgEl.textContent = 'Zotero å·²æ–°å¢ã€‚';
                  zoteroIdInput.value = '';
                  zoteroKeyInput.value = '';
                  zoteroAliasInput.value = '';
                  loadSubscriptions();
                }
              } catch (e) {
                console.error(e);
                msgEl.textContent = 'æ–°å¢ Zotero å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
              }
            };

            const doTrack = async () => {
              const checked = document.querySelector('input[name="arxiv-choice"]:checked');
              if (!checked) {
                msgEl.textContent = 'è¯·å…ˆåœ¨ç»“æœä¸­é€‰ä¸­ä¸€ç¯‡è®ºæ–‡';
                return;
              }
              const arxivId = checked.value;
              // ä»é€‰ä¸­è¡Œçš„æ“ä½œåŒºè·å–å¤‡æ³¨è¾“å…¥æ¡†
              const selectedRow = checked.closest('.arxiv-result-item');
              const trackAliasInput = selectedRow ? selectedRow.querySelector('.arxiv-track-alias-input') : null;
              const alias = (trackAliasInput && trackAliasInput.value || '').trim();
              if (!alias) {
                msgEl.textContent = 'å¤‡æ³¨ä¸ºå¿…å¡«é¡¹';
                return;
              }
              msgEl.textContent = 'æ­£åœ¨åŠ å…¥åå°...';
              try {
                const res = await fetch('/api/arxiv_track', {
                  method: 'POST',
                  headers: {'Content-Type': 'application/json'},
                  body: JSON.stringify({ arxiv_id: arxivId, alias }),
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) {
                  msgEl.textContent = data.detail || 'åŠ å…¥åå°å¤±è´¥';
                } else {
                  msgEl.textContent = 'å·²åŠ å…¥åå°ï¼ˆå¦‚æœä¹‹å‰å·²å­˜åœ¨åˆ™ä¼šå¿½ç•¥ï¼‰ã€‚';
                  // æˆåŠŸååˆ·æ–°è®¢é˜…è®ºæ–‡åˆ—è¡¨
                  loadSubscriptions();
                  // æ¸…ç©ºå½“å‰é€‰ä¸­è¡Œçš„å¤‡æ³¨è¾“å…¥æ¡†
                  const checked = document.querySelector('input[name="arxiv-choice"]:checked');
                  if (checked) {
                    const selectedRow = checked.closest('.arxiv-result-item');
                    const trackAliasInput = selectedRow ? selectedRow.querySelector('.arxiv-track-alias-input') : null;
                    if (trackAliasInput) trackAliasInput.value = '';
                  }
                }
              } catch (e) {
                console.error(e);
                msgEl.textContent = 'åŠ å…¥åå°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
              }
            };

            if (openBtn && !openBtn._bound) {
              openBtn._bound = true;
              openBtn.addEventListener('click', openOverlay);
            }
            if (closeBtn && !closeBtn._bound) {
              closeBtn._bound = true;
              closeBtn.addEventListener('click', closeOverlay);
            }
            // ç‚¹å‡»ç°è‰²é®ç½©åŒºåŸŸä¹Ÿå…³é—­çª—å£ï¼ˆæŒ‰ä¸‹æ—¶ç«‹å³å…³é—­ï¼Œç‚¹å‡»å†…éƒ¨é¢æ¿ä¸å…³é—­ï¼‰
            if (overlay && !overlay._boundClick) {
              overlay._boundClick = true;
              overlay.addEventListener('mousedown', (e) => {
                if (e.target === overlay) {
                  closeOverlay();
                }
              });
            }
            if (searchBtn && !searchBtn._bound) {
              searchBtn._bound = true;
              searchBtn.addEventListener('click', doSearch);
            }
            if (input && !input._bound) {
              input._bound = true;
              input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey && !e.isComposing) {
                  e.preventDefault();
                  doSearch();
                }
              });
            }
            if (keywordAddBtn && !keywordAddBtn._bound) {
              keywordAddBtn._bound = true;
              keywordAddBtn.addEventListener('click', addKeyword);
            }
            if (keywordAliasInput && !keywordAliasInput._bound) {
              keywordAliasInput._bound = true;
              keywordAliasInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey && !e.isComposing) {
                  e.preventDefault();
                  addKeyword();
                }
              });
            }
            if (zoteroAddBtn && !zoteroAddBtn._bound) {
              zoteroAddBtn._bound = true;
              zoteroAddBtn.addEventListener('click', addZotero);
            }
            if (zoteroAliasInput && !zoteroAliasInput._bound) {
              zoteroAliasInput._bound = true;
              zoteroAliasInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey && !e.isComposing) {
                  e.preventDefault();
                  addZotero();
                }
              });
            }
            
            // ç›‘å¬åŠ è½½è®¢é˜…æ•°æ®çš„è‡ªå®šä¹‰äº‹ä»¶ï¼ˆç”¨äºæ–°æŒ‰é’®ï¼‰
            if (!document._arxivLoadSubscriptionsEventBound) {
              document._arxivLoadSubscriptionsEventBound = true;
              document.addEventListener('load-arxiv-subscriptions', function() {
                loadSubscriptions();
              });
            }
          };

          // 4. å‘é€æ¶ˆæ¯ (API)
          const sendMessage = async () => {
            const input = document.getElementById('user-input');
            const btn = document.getElementById('send-btn');
            const question = input.value.trim();
            const paperId = getPaperId();
            
            const paperContent = document.querySelector('.markdown-section').innerText; 

            if (!question) return;

            // UI é”å®š
            input.disabled = true;
            btn.disabled = true;
            btn.innerText = "æ€è€ƒä¸­...";
            
            // ä¹è§‚æ›´æ–°
            const historyDiv = document.getElementById('chat-history');
            historyDiv.innerHTML += `
                <div class="msg-item">
                    <div><span class="msg-role user">ğŸ‘¤ ä½ </span></div>
                    <div class="msg-content">${question}</div>
                </div>
            `;
            historyDiv.scrollTop = historyDiv.scrollHeight;

            // ä¸º AI åˆ›å»ºä¸€ä¸ªå ä½æ¶ˆæ¯ï¼ŒåŒ…å«â€œæ€è€ƒè¿‡ç¨‹ + å›ç­”å†…å®¹â€
            const aiItem = document.createElement('div');
            aiItem.className = 'msg-item';
            aiItem.innerHTML = `
                <div>
                  <span class="msg-role ai">ğŸ¤– AI åŠ©æ‰‹</span>
                </div>
                <div class="thinking-container" style="margin-top:8px; border-left:3px solid #ddd; padding-left:8px; font-size:0.85rem; color:#666; display:none;">
                  <div style="display:flex; align-items:center; justify-content:space-between;">
                    <span>æ€è€ƒè¿‡ç¨‹</span>
                    <button class="thinking-toggle" style="margin-left:8px; font-size:0.75rem; padding:2px 6px;">æŠ˜å </button>
                  </div>
                  <div class="thinking-content" style="white-space:pre-wrap; margin-top:4px;"></div>
                </div>
                <div class="msg-content"></div>
            `;
            historyDiv.appendChild(aiItem);

            const thinkingContainer = aiItem.querySelector('.thinking-container');
            const thinkingContent = aiItem.querySelector('.thinking-content');
            const toggleBtn = aiItem.querySelector('.thinking-toggle');
            const aiAnswerDiv = aiItem.querySelector('.msg-content');

            let thinkingBuffer = '';
            let answerBuffer = '';
            let thinkingCollapsed = false;
            let hasShownAnswer = false;
            let renderTimer = null;
            let streamBuffer = '';

            const applyThinkingCollapsedView = () => {
              if (!thinkingBuffer) return;
              const source = normalizeTables(thinkingBuffer);
              const maxLines = 3;
              let toRender = source;

              if (thinkingCollapsed) {
                const lines = source.split('\n');
                toRender = lines.slice(0, maxLines).join('\n') + (lines.length > maxLines ? '\n...' : '');
                toggleBtn.textContent = 'å±•å¼€';
              } else {
                toggleBtn.textContent = 'æŠ˜å ';
              }

              thinkingContent.innerHTML = renderMarkdownWithTables(toRender);
              renderMathInEl(thinkingContent);
            };

            const scheduleRender = () => {
              if (renderTimer) return;
              renderTimer = setTimeout(() => {
                renderTimer = null;

                // æ¸²æŸ“æ€è€ƒåŒº
                if (thinkingBuffer) {
                  thinkingContainer.style.display = 'block';
                  applyThinkingCollapsedView();
                }

                // æ¸²æŸ“æ­£å¼å›ç­”åŒº
                if (answerBuffer) {
                  const normalizedAnswer = normalizeTables(answerBuffer);
                  aiAnswerDiv.innerHTML = renderMarkdownWithTables(normalizedAnswer);
                  renderMathInEl(aiAnswerDiv);
                }
              }, 80);
            };

            toggleBtn.addEventListener('click', () => {
              thinkingCollapsed = !thinkingCollapsed;
              applyThinkingCollapsedView();
            });

            try {
              const res = await fetch('/api/chat_stream', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    paper_id: paperId,
                    question: question,
                    paper_content: paperContent 
                })
              });
              if (!res.body) {
                throw new Error('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒæµå¼å“åº”è¯»å–');
              }

              const reader = res.body.getReader();
              const decoder = new TextDecoder('utf-8');

              while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                const rawChunk = decoder.decode(value, { stream: true });

                // ä½¿ç”¨æŒ‰è¡Œ JSON åè®®è§£ææœåŠ¡ç«¯æ¨é€çš„æ•°æ®
                streamBuffer += rawChunk;
                const parts = streamBuffer.split('\n');
                streamBuffer = parts.pop() || '';

                for (const line of parts) {
                  const trimmed = line.trim();
                  if (!trimmed) continue;
                  let msg;
                  try {
                    msg = JSON.parse(trimmed);
                  } catch (e) {
                    console.error('è§£ææµå¼ JSON å¤±è´¥:', e, trimmed);
                    continue;
                  }

                  if (msg.type === 'thinking') {
                    thinkingBuffer += msg.content || '';
                    thinkingContainer.style.display = 'block';
                    // æ€è€ƒé˜¶æ®µé»˜è®¤å±•å¼€
                    thinkingCollapsed = false;
                    scheduleRender();
                  } else if (msg.type === 'answer') {
                    answerBuffer += msg.content || '';
                    scheduleRender();
                    // ä¸€æ—¦è¿›å…¥ç­”æ¡ˆé˜¶æ®µï¼Œè‹¥å­˜åœ¨æ€è€ƒå†…å®¹åˆ™æŠ˜å 
                    if (thinkingBuffer && !hasShownAnswer) {
                      hasShownAnswer = true;
                      thinkingCollapsed = true;
                      scheduleRender();
                    }
                  } else if (msg.type === 'error') {
                    answerBuffer += `\n[ERROR] ${msg.content || ''}`;
                    scheduleRender();
                  }
                }

                historyDiv.scrollTop = historyDiv.scrollHeight;
              }

              // æµç»“æŸåä¸å†ç«‹å³é‡è½½å†å²è®°å½•ï¼Œé¿å…è¦†ç›–å¸¦â€œæ€è€ƒè¿‡ç¨‹â€çš„å½“å‰æ¶ˆæ¯
              // å†å²è®°å½•ä¼šåœ¨é¡µé¢é‡æ–°æ‰“å¼€æ—¶é‡æ–°ä»åç«¯åŠ è½½
              input.value = '';
            } catch (e) {
              alert("å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•");
            } finally {
              input.disabled = false;
              btn.disabled = false;
              btn.innerText = "å‘é€";
              input.focus();
            }
          };

          // --- Docsify ç”Ÿå‘½å‘¨æœŸé’©å­ ---
          
          hook.doneEach(function() {
            // A. å¯¹æ­£æ–‡åŒºåŸŸè¿›è¡Œä¸€æ¬¡å…¨å±€å…¬å¼æ¸²æŸ“ï¼ˆæ”¯æŒ $...$ / $$...$$ï¼‰
            const mainContent = document.querySelector('.markdown-section');
            if (mainContent) {
              renderMathInEl(mainContent);

              // B. å°† Chat UI è¿½åŠ åˆ°æ–‡ç« åº•éƒ¨
              const div = document.createElement('div');
              div.innerHTML = renderChatUI();
              mainContent.appendChild(div);
            }

            // C. ç»‘å®šäº‹ä»¶
            const sendBtnEl = document.getElementById('send-btn');
            if (sendBtnEl) {
              sendBtnEl.addEventListener('click', sendMessage);
            }

            // è¾“å…¥æ¡†å›è½¦å‘é€ï¼ˆEnter å‘é€ã€Shift+Enter æ¢è¡Œï¼‰
            const inputEl = document.getElementById('user-input');
            if (inputEl) {
              inputEl.addEventListener('keydown', (e) => {
                // isComposing ç”¨äºé¿å…ä¸­æ–‡è¾“å…¥æ³•æ‹¼å†™è¿‡ç¨‹ä¸­è¯¯è§¦
                if (e.key === 'Enter' && !e.shiftKey && !e.isComposing) {
                  e.preventDefault();
                  sendMessage();
                }
              });
            }

            // D. åˆå§‹åŠ è½½æ•°æ®ï¼ˆä»…åœ¨é¡µé¢åŠ è½½æ—¶è¯·æ±‚ä¸€æ¬¡ï¼‰
            const paperId = getPaperId();
            loadHistory(paperId);

            // ----------------------------------------------------
            // E. ã€é‡ç‚¹ä¿®æ”¹ã€‘Zotero å…ƒæ•°æ®æ³¨å…¥é€»è¾‘ (å¸¦å»¶æ—¶å’Œå”¤é†’)
            // ----------------------------------------------------
            setTimeout(() => {
                try {
                  // 1. æŠ“å–æ ‡é¢˜ (ä¼˜å…ˆæŠ“ H1)
                  const titleEl = document.querySelector('.markdown-section h1');
                  const title = titleEl ? titleEl.innerText : document.title;

                  // 2. æŠ“å– PDF é“¾æ¥ (ä¼˜å…ˆæŠ“ ArXiv)
                  let pdfLinkEl = document.querySelector('a[href*="arxiv.org/pdf"]');
                  // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå†è¯•ç€æ‰¾ä»»ä½•ç»“å°¾æ˜¯ .pdf çš„é“¾æ¥
                  if (!pdfLinkEl) {
                     pdfLinkEl = document.querySelector('a[href$=".pdf"]');
                  }
                  
                  let pdfUrl = '';
                  if (pdfLinkEl) {
                    // è½¬ä¸ºç»å¯¹è·¯å¾„
                    pdfUrl = new URL(pdfLinkEl.href, window.location.href).href;
                  }

                  // 3. æŠ“å–æ—¥æœŸ
                  let date = '';
                  const matchDate = vm.route.file.match(/(\d{4}-\d{2}-\d{2})/);
                  if (matchDate) {
                    date = matchDate[1];
                  }
                  const citationDate = date ? date.replace(/-/g, '/') : '';

                  // 4. æŠ“å–ä½œè€…
                  let authors = [];
                  document.querySelectorAll('.markdown-section p').forEach(p => {
                    if (p.innerText.includes('Authors:')) {
                      const text = p.innerText.replace('Authors:', '').trim();
                      authors = text.split(/,|ï¼Œ/).map(a => a.trim());
                    }
                  });

                  // 5. å†™å…¥ Meta æ ‡ç­¾
                  console.log("Updating Zotero metadata for:", title);
                  updateMetaTag('citation_title', title);
                  updateMetaTag('citation_journal_title', 'Daily Paper Reader (ArXiv)'); // å¿…é¡»æœ‰è¿™ä¸ª
                  updateMetaTag('citation_pdf_url', pdfUrl, { useFallback: false });
                  updateMetaTag('citation_publication_date', date);
                  updateMetaTag('citation_date', citationDate);

                  document.querySelectorAll('meta[name="citation_author"]').forEach(el => el.remove());
                  const authorList = authors.length ? authors : defaultAuthors;
                  authorList.forEach(author => {
                    const meta = document.createElement('meta');
                    meta.name = 'citation_author';
                    meta.content = author;
                    document.head.appendChild(meta);
                  });

                  // 6. ã€å…³é”®ã€‘å‘é€ Zotero æ›´æ–°äº‹ä»¶
                  // å‘Šè¯‰æ’ä»¶é‡æ–°æ‰«æé¡µé¢
                  document.dispatchEvent(new Event('ZoteroItemUpdated', {
                      bubbles: true,
                      cancelable: true
                  }));

                } catch (e) {
                  console.error('Zotero meta update failed:', e);
                }
            }, 1); // å»¶è¿Ÿ 800ms æ‰§è¡Œï¼Œç­‰å¾… DOM æ¸²æŸ“å®Œæ¯•

            // F. ç¡®ä¿ Arxiv æœç´¢ UI å­˜åœ¨
            ensureArxivSearchUI();
            
            // G. ç›‘å¬è‡ªå®šä¹‰äº‹ä»¶ï¼Œç”¨äºæ–°æŒ‰é’®è§¦å‘ UI åˆå§‹åŒ–
            document.addEventListener('ensure-arxiv-ui', function() {
              ensureArxivSearchUI();
            });
          });
        }
      ]
    }
  </script>
  
  <!-- ä¾§è¾¹æ å®½åº¦æ‹–æ‹½è„šæœ¬ -->
  <script>
    (function() {
      function setupSidebarResizer() {
        if (window.innerWidth <= 768) return;
        if (document.getElementById('sidebar-resizer')) return;

        var resizer = document.createElement('div');
        resizer.id = 'sidebar-resizer';
        document.body.appendChild(resizer);

        var dragging = false;

        resizer.addEventListener('mousedown', function(e) {
          dragging = true;
          e.preventDefault();
        });

        window.addEventListener('mousemove', function(e) {
          if (!dragging) return;
          var styles = getComputedStyle(document.documentElement);
          var min = parseInt(styles.getPropertyValue('--sidebar-min-width')) || 180;
          var max = parseInt(styles.getPropertyValue('--sidebar-max-width')) || 480;
          var newWidth = e.clientX;
          if (newWidth < min) newWidth = min;
          if (newWidth > max) newWidth = max;
          document.documentElement.style.setProperty('--sidebar-width', newWidth + 'px');
        });

        window.addEventListener('mouseup', function() {
          dragging = false;
        });
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', setupSidebarResizer);
      } else {
        setupSidebarResizer();
      }

      window.addEventListener('resize', function() {
        var resizer = document.getElementById('sidebar-resizer');
        if (window.innerWidth <= 768) {
          if (resizer) resizer.style.display = 'none';
        } else {
          if (resizer) {
            resizer.style.display = 'block';
          } else {
            setupSidebarResizer();
          }
        }
      });
    })();
  </script>

  <!-- è‡ªå®šä¹‰æŒ‰é’®è„šæœ¬ -->
  <script>
    (function() {
      function createCustomButton() {
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
        if (document.getElementById('custom-toggle-btn')) return;
        
        // ç­‰å¾… sidebar-toggle å‡ºç°
        var sidebarToggle = document.querySelector('.sidebar-toggle');
        if (!sidebarToggle) {
          setTimeout(createCustomButton, 100);
          return;
        }

        // åˆ›å»ºè‡ªå®šä¹‰æŒ‰é’®
        var btn = document.createElement('button');
        btn.id = 'custom-toggle-btn';
        btn.className = 'custom-toggle-btn';
        btn.innerHTML = 'ğŸ“š'; // è®¢é˜…ç®¡ç†å›¾æ ‡
        btn.title = 'è®¢é˜…ç®¡ç†'; // é¼ æ ‡æ‚¬åœæç¤º
        
        // æ·»åŠ ç‚¹å‡»äº‹ä»¶ - æ‰“å¼€è®¢é˜…ç®¡ç†æµ®å±‚
        btn.addEventListener('click', function() {
          // ç¡®ä¿ UI å·²åˆå§‹åŒ–ï¼ˆå¦‚æœè¿˜æ²¡æœ‰åˆ›å»ºå°±å…ˆåˆ›å»ºï¼‰
          if (typeof window.$docsify !== 'undefined') {
            // ç›´æ¥è°ƒç”¨é¡µé¢ä¸Šå·²å®šä¹‰çš„ ensureArxivSearchUI å‡½æ•°
            var event = new CustomEvent('ensure-arxiv-ui');
            document.dispatchEvent(event);
          }
          
          // å»¶è¿Ÿä¸€ä¸‹ç¡®ä¿ UI å·²åˆ›å»ºï¼Œç„¶åè§¦å‘æ‰“å¼€æµ®å±‚å’ŒåŠ è½½æ•°æ®
          setTimeout(function() {
            // è§¦å‘åŠ è½½è®¢é˜…æ•°æ®çš„äº‹ä»¶
            var loadEvent = new CustomEvent('load-arxiv-subscriptions');
            document.dispatchEvent(loadEvent);
            
            var overlay = document.getElementById('arxiv-search-overlay');
            if (overlay) {
              overlay.style.display = 'flex';
            }
          }, 100);
        });
        
        // æ’å…¥åˆ°é¡µé¢
        document.body.appendChild(btn);
      }

      // é¡µé¢åŠ è½½ååˆ›å»ºæŒ‰é’®
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', createCustomButton);
      } else {
        createCustomButton();
      }
    })();
  </script>

  <script src="//cdn.jsdelivr.net/npm/docsify@4/lib/docsify.min.js"></script>
</body>
</html>

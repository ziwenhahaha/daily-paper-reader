Title: Generative structural elucidation from mass spectra as an iterative optimization problem

URL Source: https://arxiv.org/pdf/2602.07709v1

Published Time: Tue, 10 Feb 2026 01:54:25 GMT

Number of Pages: 38

Markdown Content:
# Generative structural elucidation from mass spectra as an iterative optimization problem 

## Mrunali Manjrekar 1, Runzhong Wang 2,3 , Samuel Goldman 1,Jenna C. Fromer 2, Connor W. Coley 2,3* 

1Computational and Systems Biology, Massachusetts Institute of Technology, Cambridge, MA, USA. 

2Department of Chemical Engineering, Massachusetts Institute of Technology, Cambridge, MA, USA. 

3Department of Electrical Engineering and Computer Science, Massachusetts Institute of Technology, Cambridge, MA, USA. *Corresponding author(s). E-mail(s): ccoley@mit.edu; 

Abstract 

Liquid chromatography tandem mass spectrometry (LC-MS/MS) is a critical analytical technique for molecular identification across metabolomics, environ-mental chemistry, and chemical forensics. A variety of computational methods have emerged for structural annotation of spectral features of interest, but many of these features cannot be confidently annotated with reference struc-tures or spectra. Here, we introduce FOAM (Formula-constrained Optimization for Annotating Metabolites), a computational workflow that poses structure elucidation from LC-MS/MS as an iterative optimization problem. FOAM cou-ples a formula-constrained graph genetic algorithm with spectral simulation to explore candidate annotations given an experimental spectrum. We demonstrate FOAM’s performance on the NIST’20 and MassSpecGym datasets as both a standalone elucidation pipeline and as a complement to existing inverse mod-els. This work establishes iterative optimization as an effective and extensible paradigm for structural elucidation. 

Keywords: LC-MS/MS, Mass spectrometry, Structural elucidation, Genetic algorithms, Molecular optimization 

1

> arXiv:2602.07709v1 [q-bio.QM] 7 Feb 2026

# Introduction 

Liquid chromatography tandem mass spectrometry (LC-MS/MS) forms a critical com-ponent of the molecular discovery workflow present across many domains, including metabolomics [1–6], environmental monitoring [7–9], and chemical forensics [10–13]. The shared task across these domains is to elucidate the structure of a molecule from its experimental MS2 spectrum, commonly referred to as a “fragmentation pattern”, in addition to a high resolution precursor mass that provides information about its molecular formula. Matching these experimental spectra to reference spectral libraries can provide annotations for the limited number of structures with reference spectra [14–16] but leaves the majority of spectra in complex samples unannotated [17, 18]. Structural elucidation closely mirrors the more general challenge of molecular design (Figure 1a), as both endeavors pursue structures that optimize one or more objectives. In structural elucidation, the primary objective to pursue is the similarity between the experimental spectrum of interest and the spectrum of the hypothesized structure. Just as machine-learning and physics-based methods are applied to virtual screening, spectral simulation tools such as ICEBERG [19, 20], CFM-ID [21], FraGN-Net [22], and others [23–26] can be used to rank untargeted compound libraries, such as PubChem [27] by these structures’ predicted spectral similarities to the observed spectrum. Enumerative strategies that apply chemical transformations [20, 31–34] or produce constitutional isomers from molecular formula alone [35, 36] can expand the consid-ered chemical space beyond that captured by existing virtual libraries. Generative methods can, in principle, explore an even more diverse chemical space by learning to sample from the distribution of molecules in a reference library; two recent examples have demonstrated the untargeted generation of hypothetical metabolites given known ones [37] and the untargeted generation of candidates with a particular molecular for-mula given enumerated constitutional isomers [38]. Analogous to generative methods that design candidates conditioned on drug-relevant properties [39, 40], conditional generative models can learn a spectrum-to-structure mapping [28, 29, 41–43]. These models are often probabilistic in nature, estimating the distribution Pr(mol |spec) to sample a set of candidates when given a spectrum. Related strategies developed earlier have learned a spectrum-to-fingerprint mapping [44, 45] with the intention of query-ing against molecules in virtual libraries, rather than generating structures directly. Some of these recent conditional generative models leverage this learned fingerprint to condition their structure proposals. The dominant paradigm of computer-aided molec-ular design, arguably, is through iterative optimization. Surrogate models developed to screen virtual libraries can provide data-driven feedback to inform the design of new structures in a closed-loop manner. While the choice of the design protocol may vary—how molecules are proposed and how property scores inform the next round of design [46, 47]—the underlying goal is the progressive refinement of candidates through successive iterations. In structural elucidation, these iterative strategies could utilize spectral simulation surrogates to pursue the property of spectral similarity. Recent elucidation methods in the domain of NMR spectroscopy have pursued this optimiza-tion approach, adopting oracles that estimate spectral consistency (via simulation or 2Fig. 1 (a) We view structural elucidation as a special case of the molecular optimization problem common to computer-aided molecular design strategies; our goal is to discover the molecule that best explains the experimental spectrum. A spectrum simulation model [20] and corresponding spectral similarity objective assume the role of a property prediction oracle. Spectral similarity is a shared pursuit of retrieval-based methods, which mirror virtual screening approaches in molecular design for identifying optimal candidates within a fixed list of candidates. Conditional generative models provide one option to propose new molecules de novo for both drug design and structure elucidation [28, 29]. Similarly, framing elucidation as an iterative optimization problem enables guidance by the spectral similarity objective in the same manner as iterative molecular optimization. (b) Overview of the FOAM method. Given a target spectrum T , seed structures with matching formulae are first collected (for example, retrieved from a existing database or proposed by another elucidation tool) (Step 1). These structures are fragmented with a spectral simulator (Step 2), ICEBERG [19, 20], and compared to the target spectrum to compute their spectral similarities (Step 3). These similarities are considered alongside structural complexity (SAScore) [30] to calculate the Pareto ranking of candidates via non-dominated sorting. FOAM selects the top-scoring candidates to form the mating pool (Step 4) of parents for the next generation of offspring; FOAM then applies formula-constrained crossover and mutation operations to this pool to generate new candidates that maintain the desired formula (Step 5). The process repeats until the termination criterion is reached (Step 6), and the top-k candidates are extracted. 

3latent representation) and graph-based generation mechanisms to produce candidates [48, 49]. In this work, we describe FOAM (Formula-Constrained Optimization for Annota-tion of Metabolites), a method for de novo structural elucidation from tandem mass spectra as an iterative optimization problem (Figure 1b). FOAM frames elucidation as a search constrained by a known chemical formula (as hypothesized or predicted from formula annotation tools). Its objective is to maximize predicted alignment to the experimental spectrum. FOAM employs ICEBERG [19, 20], a geometric deep learning model for spectral prediction, to fragment candidates in silico and score their spectral similarities to the experimental spectrum. A formula-constrained and multi-objective graph genetic algorithm [50] iteratively proposes new structures for spectral similar-ity scoring that retain the specified molecular formula. These steps proceed iteratively until a specified termination criterion is met, and the final set of candidates are ranked by predicted spectral similarity. By framing structure elucidation from mass spectra as an optimization problem, FOAM provides several advantages. Foremost, it retains the spectral similarity objec-tive inherent to retrieval-based methods and benefits from recent advances in accurate spectral prediction while not being limited to pre-enumerated candidate sets. In con-trast to other spectrum-to-structure de novo conditional generators, FOAM accepts any number of starting candidate structures to help orient its search. Finally, FOAM’s multiobjective setup enables the optimization of auxiliary properties beyond spectral similarity alone. We demonstrate that FOAM achieves a high degree of success in recovering the true structure and ranking it highly (i.e., in its top 10 proposals) on a holdout set of the NIST’20 reference library, and demonstrates competitive bene-fits when utilized in tandem with other elucidation methods on the MassSpecGym benchmark. 

# Results 

## The FOAM framework 

As an iterative optimization tool for elucidation, FOAM integrates (a) a structure-to-spectrum simulator, ICEBERG [19, 20], to predict spectral similarity to the reference spectrum with (b) a formula-constrained graph genetic algorithm to generate and mod-ify hypothetical structure annotations (Figure 1b). We have recently demonstrated the utility of ICEBERG in quantitative benchmarks and prospective experimental case studies [20], lending confidence to its adoption as a surrogate model in our optimization objective. In Step 1, given the target spectrum T and corresponding MS1 information, formula annotators such as SIRIUS [44], MIST-CF [51], or BUDDY [52] can produce a chemical formula hypothesis F . We first retrieve a set of seed structures that match 

F from a virtual library such as PubChem [27]. Conditional molecular generators and other elucidation tools can also contribute seed structures to this population, as dis-cussed later. In Step 2, ICEBERG simulates these structures’ spectra with the same instrumental parameters (collision energy, adduct, instrument if provided). In Step 3, we evaluate the spectral entropy similarities [53] between the predicted spectra and the reference spectra. In Step 4, considering these similarities alongside auxiliary objectives 4(e.g., SAScore [30] for structural complexity in our present implementation), FOAM then constructs a Pareto ranking of structures and uses non-dominated sorting [54] to form the mating pool. From this pool, in Step 5, a graph genetic evolutionary algo-rithm [50] applies formula-constrained crossover and mutation operations to generate new molecular candidates that maintain the desired formula. The steps of simulation, scoring, selection, and propagation constitute one generation in FOAM; these genera-tions repeat until FOAM meets some termination criterion (Step 6). This termination criterion may be the number of generations, the number of scored molecules, or some percentage of molecules that pass a spectral similarity cutoff (absolute or relative). FOAM concludes by providing a candidate set sorted by spectral similarity. Impor-tantly, FOAM only needs the experimental spectrum and target molecule’s formula to make structure proposals. We evaluate FOAM’s ability to search for structures of interest on two commonly adopted benchmarks: NIST’20 [55] and MassSpecGym [56]. For NIST’20, we adopt the random (seed=1) train-validation-test split as used by prior work [19, 20]. In both settings, we train ICEBERG on the specified training set and perform elucidation experiments only on the test spectra. All elucidation experiments use a candidate pop-ulation of 200 and generate up to 600 novel offspring in each generation. To regularize and improve the quality of structures, we incorporate the SAScore [30] as a secondary objective penalizing structural complexity. We collect the top-1 and top-10 candidate sets ranked only by spectral similarity for evaluation. For NIST’20, seed structures include all PubChem formula matches (with the true structure excluded to simulate discovery), and FOAM terminates searches after 7,500 calls. For MassSpecGym, we additionally include samples from DiffMS [29] and terminate searches after 5,000 calls. We focus our primary evaluations on the NIST’20 set, as it is both larger and more uniform in reporting collision energies compared to MassSpecGym. 

## FOAM successfully optimizes candidate structures for spectral consistency 

We first examine FOAM’s performance as an optimizer, isolating its search efficacy from the accuracy of ICEBERG as a spectral prediction tool. The spectral similarity of the top candidates exhibits a consistent increase as the genetic algorithm pro-ceeds through multiple generations (Figure 2a); the average spectral similarity of the top 10 structures increases by 0.09 over the course of the search. This demonstrates that the formula-constrained mutation and crossover operations succeed in expand-ing the chemical space around seed molecules in a manner that enables incremental improvements each generation. Note that since this (averaged) metric represents pre-dictive estimates of spectral consistencies, we do not expect these metrics to reach the hypothetical upper bound of 1.0. Our subsequent evaluations focus on FOAM’s ability to encounter and highly rank the true chemical structure. With a sufficient number of generations allowed for exploration, FOAM encounters the true molecule two-thirds (68.1%) of the time (Figure 2b), finding almost half (50.6%) of these structures within the first three gen-erations. Compared to the increase in spectral similarity we observe, the encounter rate exhibits a more dramatic increase, reflecting that the search remains productive 5Fig. 2 Performance of FOAM on a random test subset of NIST’20 as adopted from ICEBERG [20]. (a) The primary objective function being maximized, the spectral similarity between the given exper-imental spectrum and the predicted spectrum of a proposed structure, exhibits a steady increase over the course of 60 generations. (b) FOAM proposes the true molecule 68% of the time, irrespective of how the structure ranks among the full list of candidates. (c) Structural similarity, when taking only the top-scoring candidates as ranked by predicted spectral similarity, peaks at generation 2 (Best of 1) or 3 (Best of 10) and slowly decays afterward, reflecting the accumulation of competing decoy struc-tures with higher predicted spectral similarity. (d) After only three generations, the true molecule is ranked first 11% of the time and in the top 10 proposals 31% of the time. The maximum values these can be are upper-bounded by the encounter rates in (b), as they are dependent on having seen the true molecule. Generations are plotted on a symmetric log scale. All metrics are plotted with 99.9% confidence intervals, computed using bootstrapping (n=5,000) estimation of the mean. 

6even when spectral similarity improves slowly. The immediate increase observed after just one generation signals local refinement of seed structures; the subsequent steady increase demonstrates that further exploration of chemical space helps recover the true molecule. One reason for why the remaining 31.9% searches fail to recover the true molecule is the imperfect nature of spectral prediction, which may lead the optimiza-tion toward unproductive or misleading structural changes. We examine how many of FOAM’s searches find a molecule with equal or higher spectral similarity (which we call “decoys”) (Supplementary Figure S2a), and find that 95.2% of searches eventually see at least one decoy. This demonstrates that FOAM is given an adequate compu-tational budget to accomplish its primary optimization task in the vast majority of cases. Therefore, spectral prediction accuracy is the primary bottleneck to greater success rates rather than insufficient exploration of chemical space. The encounter rate increases monotonically with the number of generations, by definition. However, as FOAM generates more high-scoring candidates, ranking the true structure highly among these candidates becomes increasingly challenging. To evaluate the top-1 and top-10 candidate sets as ranked by predicted spectral similarity, we consider their structural similarity to the true structure as measured by Tanimoto similarity (2048-bit, radius 2 Morgan fingerprint) (Figure 2c). Unlike the monotonic trends observed for spectral similarity and encounter rate, these performance metrics peak after 2-3 generations and drop afterward. These downward trends reflect the imperfections of the spectrum prediction oracle, which the genetic algorithm success-fully exploits to generate decoys that outscore the true molecule. The best structures in the top 10 candidate sets after two generations have on average structural simi-larities of 0.62 to the true structure. This is an improvement upon the similarity of the top-ranked candidates in the seed sets from 0.52 (Generation 0, akin to retrieving from PubChem and how ICEBERG has been applied previously). Further, adopting the criteria for “meaningful” and “close” matches introduced in Butler et al. [42], we show FOAM finds more meaningful matches and close matches in its proposals than in the starting seeds (Supplementary Figure S2c-d). We further illustrate FOAM’s ability to suggest candidates that exactly match the true molecule in its top 1 and top 10 proposals (Figure 2d). These strict metrics require that FOAM both propose the true structure and rank it highly among the other many structural isomers. Note that these metrics are upper-bounded by the encounter rate. After 3 generations, FOAM ranks the true molecule in the top 10 proposals 31% of the time, and as the top-ranked proposal 11% of the time. These rankings on average tend to stay stable throughout the trajectory, worsening only slightly with extended generations. Given the challenging nature of the de novo elucidation setting and the vastness of chemical space, this absolute performance is still notable. Altogether, these evaluations underscore FOAM’s utility in exploring and prioritizing novel structures as possible annotations for LC-MS/MS spectra. 

## FOAM’s performance correlates with the relevance of seed structures and accuracy of spectral simulation 

To probe which factors most strongly determine FOAM’s success, we analyze its per-formance along two key dimensions: the relevance of the starting seed structures and 7the accuracy with which ICEBERG predicts the fragmentation of the target molecule. We quantify these by analyzing FOAM’s performance across both these contributing dimensions. Specifically, we first examine the structural similarity of FOAM’s most-similar candidate among its top 10 proposals as a metric of success. We use a constant number of generations, three, which maximizes the Top 10 Exact Match recovery (Figure 2d). As expected, we observe positive contributions toward the structural relevance of FOAM’s top-ranked candidates from both the maximum structural similarity from the available seed structures (y-axis) and the similarity between ICEBERG’s pre-dicted spectrum and the observed spectrum of the true structure (x-axis) (Figure 3a). When the initial population contains structures close to the true structure, fewer modifications need to be made to arrive at the true one. When ICEBERG is able to accurately predict the true structure’s spectrum, the objective function is more effective at guiding the search away from distracting incorrect structure hypotheses. Without structurally similar seeds and without an accurate spectral simulator, it is dif-ficult for FOAM to rank structurally relevant compounds highly (upper-left quadrant). However, an accurate spectral prediction oracle mitigates cases where the starting population is highly dissimilar from the true structure (upper-right quadrant). We first isolate the benefit of having at least one seed that is structurally similar to the true structure, by binning examples based on their maximum structural similarity present among their seeds (Figure 3b). FOAM’s probability of finding the true struc-ture in the top 10 after 3 generations (“Top 10 Exact Match”) increases from 8.1% to 31.5% when the most-similar seed structure achieves a Tanimoto similarity of 0.4-0.6 instead of 0.2-0.4. Such a similarity threshold has been commonly found in other molecular optimization contexts to indicate structural closeness, such as distinguishing minimum (dis)similarity in clustering and downsampling workflows [57, 58]. Similarly, we stratify performance by how accurate ICEBERG is for the true struc-ture, as measured by the predicted spectral similarity to its own experimental spectrum (Figure 3c). Here, success steeply ascends with increasing spectral similarity; when ICEBERG predicts the spectrum for the true molecule with 0.8 or higher spectral similarity, the probability of finding the true molecule in the top 10 reaches 53.4%. This trend underscores that the accuracy of the oracle is a critical determinant of FOAM’s success. Indeed, when we allow FOAM 25 generations to explore (Figure S5), ultimately, only the accuracy of ICEBERG strongly correlates with the structural sim-ilarity of the candidate set. As improvements are made to ICEBERG or other spectral prediction models, those improvements should directly translate to increased success of de novo elucidation with FOAM as well. The ability to estimate FOAM’s confidence prospectively would inform decisions about how to allocate experimental resources when sourcing authentic standards. Yet seed similarity and simulation accuracy require a priori knowledge of the true struc-ture, and are thus unknown in prospective settings. To perform such prospective estimation of success, we train a logistic regression model to predict the Top 10 Exact Match at the end of the trajectory using features that do not require knowing the true structure. These features include information known about the spectrum itself, such as adduct type and number of collision energies collected, but also features from the 8Fig. 3 Contributions of seed similarity and spectral prediction accuracy to FOAM’s performance, as defined by the composition of its top 10 candidate sets. (a) Best structural similarities observed in the top 10 candidate sets after three generations versus accuracy of the predicted spectrum of the true molecule (x-axis) and the similarity of the closest seed structure (2048-bit Morgan fingerprint, Tanimoto similarity) (y-axis). (b) Stratification of test spectra examples by starting seed similarity. Pink distributions show the structural similarity of the top 10 candidate sets after three generations. For visual reference, the seed similarity bins are also represented by corresponding gray range blocks for each density plot. The right-hand column quantifies the appearances of Top 10 Exact Matches in each bin. (c) Stratification of test spectra examples by spectral similarity of the true structure’s predicted spectrum to the experimental spectrum. Note that since the density plots show the spread of structural similarity, there are no corresponding gray range blocks to denote the bins. The bottom row quantifies the appearances of Top 10 Exact Matches in each bin. (d) Performance of a logistic regression model (5-fold cross-validation) predicting whether there is a Top 10 Exact Match in the final candidate set. The model achieves 0.841 AUROC using only information that would be available in prospective applications (maximum observed spectral similarity and its corresponding structure’s SAScore, adduct type, count of collision energies acquired, generation count, and number of seed structures). 

9trajectory, such as characteristics of the top candidates and number of generations elapsed. The logistic regression model achieves a mean AUROC of 0.841 in a five-fold cross-validation (Figure 3d). The fit model exhibits positive coefficients for the spectral similarity and SAScore of the top-ranked candidate, as they both correlate posi-tively with finding the true molecule in the top 10. Features describing the spectral metadata also contribute helpful discriminatory power. Adduct type can account for the variation in ICEBERG’s retrieval accuracy (Figure S4b), while higher counts of unique collision energies available can provide greater differentiation among candi-dates according to the spectral similarity objective. Together, these diagnostic signals form a practical assessment of confidence in estimating whether FOAM has succeeded in elucidating the true structure in experimental settings. 

## Optimization trajectories illustrate the evolution of top-ranking structure annotations 

We present two examples of elucidation trajectories in Figure 4. We first examine a successful search (Top 1 Exact Match) for the metabolite 1, whose spectrum, formula, and adduct we show in Figure 4a. Figure 4b displays selected snapshots of the dis-tribution of the spectral similarities and SAScores of the populations at Generation 0 (seed structures from PubChem, excluding the true structure), and after 1 and 4 generations. For purposes of retrospective visualization, each point is colored by its structural similarity to the true molecule. The top two ranked structures by predicted spectral similarity from each generation are shown below (Figure 4c). For this exam-ple, the vast majority of seed structures retrieved in Generation 0 have low spectral and structural similarity; no seeds have a spectral similarity that surpass that of the true structure (0.745) (Figure 4b, Generation 0). However, there are a few structures with structural similarity exceeding 0.4, including 2 and 3 (Figure 4c). Here, the top ranked seed structure ( 2) shares the true molecule’s angular furanocoumarin scaf-fold. After one generation (Generation 1), selective pressure prunes the lower-scoring molecules in favor of the newly generated, higher-scoring molecules–the top two struc-tures 4 and 5 now both share the same scaffold as the true structure. Though the top spectral similarity has only improved by 0.04, the Generation 1 snapshot reveals FOAM has generated numerous additional isomers with spectral similarities ranging from 0.5 to 0.7. By Generation 4, FOAM has found the true structure and ranks it as the top structure in the the population. Here, FOAM’s rank two prediction ( 6) is a linear furanocoumarin instead of an angular furanocoumarin; all other connectivity is identical. We next examine the trajectory for an example where FOAM finds the true struc-ture, a prostaglandin ( 7), but ranks it below the top 10 (Encountered, but no Top 10 Exact Match). The target spectrum for 7 (Figure 4d) exhibits relatively few high-intensity diagnostic peaks and is an [M-H+H 2O] - adduct, a poorly represented adduct in the NIST’20 training set (Table S2). Among the seed structures, only two structures (8 and 9) stand out with modest spectral similarity (0.45) to the experimental spec-trum. Yet, these structures suffice to help the search progress forward toward more 10 Fig. 4 Two example FOAM trajectories and selected candidate structures for selected generations. (a) The molecular formula, adduct, and target spectrum merged over the 12 available collision ener-gies (5%, 9%, 14%, 20%, 30%, 40%, 50%, 65%, 80%, 95%, 110%, 130%). (b) Distribution of objectives of the seed population (Generation 0), as well as the candidate populations after one and four gen-erations. (c) The true structure 1 and the top two structures 2-6 from each generation ranked by spectral similarity. The true structure is found, and ranked first, in Generation 4. (d) The molecular formula, adduct, and target spectrum merged over the 11 available collision energies (7%, 11%, 15%, 19%, 25%, 30%, 36%, 42%, 50%, 57%, and 69%).(e) Distribution of objectives as in (b) but for the search of 7, with Generations 0, 4 and 6 visualized. (f) The true structure 7 and top-ranked candi-dates by spectral similarity. Generations 0 and 4 display their top two structures 8-11 ; Generation 6 displays the top structure 12 and 28th structure. The true molecule 7 is found in Generation 6 at rank 28, which is displayed in place of the 2nd ranked molecule for this generation. Molecules are colored by their structural similarity (Tanimoto similarity, 2048-bit Morgan fingerprint) to the true molecule. Gray dashed lines mark the true molecule’s ICEBERG-predicted spectral similarity to the experimental spectrum (vertical line) and the molecule’s SAScore (horizontal line). 

11 structurally useful candidates. In the Generation 4 snapshot, we see FOAM has pro-duced many structures with spectral similarities that come close to that of the true molecule, with a number of candidates that have structural similarities of 0.6 or more. FOAM’s top two ranked structures in this generation, 10 and 11 , are decoys with spectral similarities (0.596 and 0.595) that surpass that of the true molecule (0.587), though FOAM has not yet found the true molecule. FOAM only encounters the true molecule after 6 generations, but ranks it behind 27 other decoys encountered. The top-1 structure for this generation, 14 , shares reasonably high structural similarity (0.635), with only minor differences in connectivity to the true structure. 

## FOAM is synergistic with other generative models for structure elucidation 

FOAM’s use of a seed population of candidates to initialize its search makes it flexi-ble for combination with candidate structures proposed by other elucidation models. We demonstrate such a use case with DiffMS [29], a spectrum-conditioned genera-tive model that uses discrete graph diffusion to propose candidates. We utilize the MassSpecGym benchmark [56], which features a challenging scaffold split but has been adopted for evaluation of many recent de novo structural elucidation methods. For each spectrum in the MassSpecGym test set, we generate 100 samples from DiffMS, which may overlap in structural identity (Extended Data Figure 1a) and provide them to FOAM as seeds alongside formula-matched structures from PubChem. Exact match exclusion is only applied to the PubChem seeds; any correct candidates gener-ated by DiffMS remain in the seed populations. For fairness to other methods on the MassSpecGym benchmark, we retrain ICEBERG on the MassSpecGym training set and use this model in our optimization objective. Table 1 shows the performance of DiffMS alone, DiffMS in combination with one generation of FOAM, and comparable methods. FOAM worsens DiffMS’s Top 1 Exact Match accuracy, from 2.30% to 1.50%; however, these top-1 structures share higher structural similarity, improving the MCES (maximal common edge subgraph) edit distance from 13.96 to 12.21 and its Tanimoto similarity to the true structure from 0.28 to 0.35. Fewer Top 1 Exact Matches indicates that FOAM finds decoy structures with higher spectral similarity than that of the true structure. Yet, these top-ranking structures still share higher structural similarity to the true structure than DiffMS’ best structures on average. FOAM also prioritizes many structurally relevant molecules in the top 10, making over twice as many successful true identifications (10.28%) as DiffMS (4.25%). These structures also show higher structural similarity to the true structure, sharing on average 0.53 Tanimoto similarity to the true structure. This is a considerable improvement over DiffMS alone, which only achieves 0.39 Tanimoto similarity, and reference methods. FOAM encounters the true structures in 33% of the searches after just one genera-tion, a considerable increase in coverage beyond the the 5.8% of searches where DiffMS’ samples (and thus FOAM seeds) already contained the true structure (Extended Data Figure 1b). FOAM’s top annotations also include higher proportions of “Close Matches” (Extended Data Figure 1b). 12 Table 1 Structural elucidation performance on the MassSpecGym benchmark. Top-1 Top-10 Model Acc. ↑ MCES ↓ Tani. ↑ Acc. ↑ MCES ↓ Tani. ↑                                                     

> MIST + MSNovelist [28] ∗‡ 0.00% 39.84 0.06 0.00% 18.83 0.15 MIST + Neuraldecipher [59] ∗‡ 0.00% 22.93 0.14 0.00% 21.76 0.16 Random Generation [56] 0.00% 21.11 0.08 0.00% 18.26 0.11 MS-BART [60] 1.07% 16.47 0.23 1.11% 15.12 0.28 MADGEN [43] 1.31% 27.47 0.20 1.54% 16.84 0.26 OMG (ESP) [38] 2.42% 55.43 0.13 5.53% 54.21 0.18 DiffMS [29] ‡2.30% 13.96 0.28 4.25% 11.68 0.39 FOAM (DiffMS + PubChem) 1.50% 12.21 0.35 10.28% 6.06 0.53
> The Top 1 and Top 10 candidate sets from each method are evaluated for Exact Match accuracy (Acc.), maximum common edge subgraph edit distance (MCES), and Tanimoto similarity (Tani.). The Top 10 statistics reflect the best metric observed among the 10 suggestions (i.e., lowest MCES observed), not an average. Unless otherwise noted, all metrics are reproduced from corresponding works. ‡indicates MCES was recalculated from what was originally reported. ∗indicates a method internally reimplemented, including reimplementations already shared in [29]. Myopic MCES is used to calculate the scores with a myopic threshold of 15, following the benchmark in [56]. Tanimoto similarities are computed with 2048-bit radius-2 Morgan fingerprints. Recent methods where we could not confirm the absence of data leakage are excluded from this table.

# Discussion 

In this work, we have formulated de novo structural elucidation as an iterative opti-mization problem. Our method, FOAM, uses a formula-constrained graph genetic algorithm in combination with a forward spectrum simulation model. In contrast to other inverse models that operate as black-box translators, FOAM proposes and refines candidates based on their predicted spectral consistency with the target spectrum. In this manner, it approaches structural annotation as an iterative formula-constrained search through chemical space, starting from an initial candidate population provided by virtual libraries or complementary elucidation tools. We demonstrate FOAM’s ability to infer structural annotations on a holdout set of the NIST’20 reference library. FOAM encounters the true structure during its search in two-thirds of cases and succeeds in ranking the true molecule among its top 10 annotations 31% of the time. Crucially, even when it does not rank the true struc-ture first, FOAM’s best structures nonetheless share high structural similarity to the true molecule, averaging 0.63 when considering the best structures among their top 10 annotations. By virtue of its core optimization objective, FOAM inherits the strengths and weaknesses of the specific spectrum simulator it uses. Here, our version of ICE-BERG, trained on the NIST’20 reference library, supports a wide range of adducts, both positive and negative ionization modes, collision energy ranges, and structural classes; this coverage also extends to FOAM. We partially mitigate the risk of inac-curate spectral predictions by providing a post-hoc predictor of success from the test spectra trajectories, demonstrating a 0.841 AUROC in predicting the Top 10 Exact Match. 13 Looking ahead, as FOAM’s multiobjective framing can accommodate any number of objective functions to optimize simultaneously, we anticipate that further improve-ments to elucidation are possible with the incorporation of other orthogonal sources of information. Some examples of such contextual aids that FOAM could be modified to accept include metabolite-like classifiers [37], retention-time predictors [61], and mea-sures of biosynthetic feasibility. Furthermore, while we develop methods to evaluate confidence post-hoc, if uncertainty was considered during the search itself, the current non-dominated sorting that determines the genetic algorithm’s mating pool could be replaced with selection strategies from Bayesian optimization, perhaps improving the dynamics of FOAM’s search. 14 Methods 

## Details of FOAM’s workflow and design choices 

Initialization with seed structures 

To begin its search, FOAM must be first provided a starting pool of candidate struc-tures. These “seed” structures must match the chemical formula specified, which our experiments assume is known (for example, through successful inference from high-resolution MS1 in combination with the MS2 spectrum). At least one seed must be provided for the optimization to proceed. Seed structures are deduplicated and any stereochemical information is removed. In our experiments, our seed sets include (at least) all formula-matched molecules from PubChem as collected in January 2024, excluding the true molecule as determined by first layer InChI match. All seed struc-tures are scored for their predicted spectral similarity to the true molecule. The scoring of these molecules does not count toward the maximum number of spectrum similarity evaluations when this is used as a termination criterion for the search. 

Spectrum simulation and scoring 

To score candidate structures in terms of their agreement with the target spectrum, candidate molecular structures are fragmented with ICEBERG [20] under the same collision energies and adduct specified by the target spectrum provided. We then use the entropy similarity metric [53] to quantify the spectral similarity between each of the candidate spectra and the target spectrum; benchmarking experiments with ICEBERG previously suggested that the entropy metric can be more informative than cosine similarity for ranking candidates [20]. When multiple collision energies are available, the entropy similarity is computed per individual collision energy, then averaged over all the energies to yield a single scalar measure of the similarity. Each spectrum has an assigned weight when averaging, such that spectra with more peaks, which are usually obtained at proper collision energies and are more informative, are considered more important. Any spectrum with 5 or more peaks has a weight of 4, 1-4 peaks a weight of 1, and 0 peaks a weight of 0. For simplicity throughout the text, we refer to the full set of target spectra corresponding to a single unknown structure as a singular spectrum . The number of spectra per test instance varies from 1 to 29 in the NIST’20 dataset. In the MassSpecGym dataset, each test entry contains only a single collision energy, as the benchmark intentionally defines distinct collision energies for the same unknown molecule as distinct test examples. All molecules are stored with their scores in a buffer to avoid recomputation. 

Structural complexity as a second objective 

The formula-constrained graph genetic algorithm can yield structures that are valid by chemical valence rules but highly unlikely to exist, e.g., due to unusual ring strain or rare substructures. To mitigate the risk that such unrealistic structures act as decoys and misguide the optimization trajectory, we incorporate a second objective of structural complexity in addition to spectral similarity. Specifically, we use the 15 synthetic accessibility score (SAscore [30]) as implemented in RDKit [62], linearly normalized from 1-10 to 0-1: 

S = 10 − SAScore 9so that a higher S indicates a molecule that is easier to synthesize. By incorporating this score as an second objective in a multi-objective optimization, FOAM can prior-itize exploring candidates that are more structurally reasonable instead of structures that may have competitive spectral similarities but are too complex to be realistic annotations. 

## Multi-objective optimization and Pareto ranking 

The spectral similarity and structural complexity objectives are incorporated into a commonly adopted multiobjective modification of genetic algorithms, NSGA-II [54]. The NSGA-II framework relies on several key algorithmic choices: 

• Non-dominated sorting of candidates to produce a Pareto ranking of candidates. Molecules with the same Pareto rank form a front; within one front of candidates, no candidate dominates, or outcompetes on all objectives of, another candidate in that front. A Pareto rank of 1 describes a molecule that is not dominated by any other candidate in the population. 

• Crowding distance to sort candidates within a front; candidates are rewarded for having objective values distant from other values of its neighboring candidates in that front. 

• Binary tournament mating selection , wherein candidates are chosen to mate based on whether it dominates another randomly selected candidate; this introduces a degree of stochasticity into which candidates are used to produce offspring for the next generation. Empirically, we found that combining both objectives into a weighted, scalarized single objective problem tended to perform worse than the multiobjective approach. This is unsurprising given the general difficulty of balancing competing optimization criteria 

a priori . To identify the most performant molecules for propagation, we apply the non-dominated sorting described above to provide each molecule with a Pareto rank. Within a front, molecules are sorted by a objective-based crowding distance metric. In all experiment settings, we then select the top 200 structures to form the mating pool of the next population. 

Formula-constrained graph genetic algorithm 

Knowledge of the molecular formula allows us to constrain the generative space to pro-duce only candidates that share the same chemical formula. We adapt the GraphGA algorithm [50] as implemented in PMO [63] to constrain the crossover and mutation operators to only make modifications that preserve the formula. These operations are illustrated in S1. The crossover operations swap fragments between two molecules with the same subformulae. These fragments must be different in connectivity to avoid the same molecules being recreated. To find these pairings, the order of bond is chosen (first, second, or third) at random. On both molecules, all potential bonds with this 16 order are broken to enumerate a set of candidate fragments. Any pair of fragments that can be successfully be swapped to yield new molecules is chosen at random to form a new offspring. Similarly, mutations to the offspring generated can also be con-sidered “swaps” between bonds on the molecule, i.e., moving any functional group connected by a single bond by swapping it with a hydrogen. To begin the offspring creation process, we use binary tournament mating selection to construct pairs of parents from the mating pool. Specifically, each parent in a pair is set by picking two random candidates in the starting population and selecting the candidate with the higher Pareto rank (this selection occurs twice to set both parents in the pair). The crossover operation is applied first to create an offspring, and then a mutation operation is applied to that offspring to introduce a minor change with a default probability of 0.20. In the case of an initial seed population with fewer than 5 structures, crossover attempts are paused (since, in the case of only 1 structure, crossover cannot proceed, and with such few structures otherwise, empirically fails even more frequently) and multiple mutation attempts are performed instead to create a sufficient number of different offspring. In all experiment settings, 600 attempts at making new offspring are made in each generation. However, usually fewer than 600 new structures are made, either because the created offspring have already been seen before (in which case they are not added back to the population), because an operation results in an invalid molecule (as determined by RDKit’s sanitization rules), or because no crossover is possible between a parental pair that would preserve the formula. 

Termination criteria 

The process of generation and scoring repeats until some termination criterion is reached. Furthermore, we apply a truncation mechanism that removes any structures with 0.35 spectral similarity or lower, once 20% of the population is greater than 0.4 spectral similarity. This further encourages propagation of high-spectral-similarity scoring molecules, removing molecules that may be in the population only because of low structural complexity. Options for the termination criterion include reaching a maximum call threshold, a maximum generation threshold, or passing a minimum spectral similarity cutoff. For both experiment sets, we utilize a maximum call thresh-old (for NIST’20 experiments, it is 7,500 calls; for MassSpecGym experiments, it is 1,500 calls); seed structures do not count toward this threshold. Note that though each molecule must be evaluated separately by ICEBERG at each collision energy provided, we do not accumulate call counts across this dimension and only accumu-late call counts across molecules. For all experiments, ranks reported are only based on spectral similarity. 

Summary of the FOAM algorithm 

An algorithmic framing of the overall method as applied for elucidation on the NIST’20 dataset is provided for clarity: 17 Algorithm 1 FOAM: Formula-constrained Optimization for Annotating Metabolites 

Require: target spectrum T , molecular formula F , spectral simulator O (ICEBERG), seed library V (e.g PubChem), external elucidation tool D (e.g., DiffMS) 

Require: max calls N , population size k, seed population size s, offspring size α,mutation size μ, (optional, only for retrospective evaluation:) true structure w

Ensure: Ranked candidate set C 

> 1:

P0 ← RetrieveSeeds (V, F ) ▷ Formula-matched structures from library V 

> 2:

if D is defined then  

> 3:

P0 ← P 0 ∪ D (T, F ) ▷ Additional suggestions from method D 

> 4:

end if  

> 5:

B ← ∅ ▷ Buffer of all scored molecules  

> 6:

t ← 0, g ← 0 ▷ Call and generation counter  

> 7:

for each molecule m ∈ P 0 do ▷ Seed scoring  

> 8:

ˆsm ← O (m) ▷ Predict spectrum  

> 9:

sim m, sa m ← EntropySimilarity (ˆ sm, T ), NormSAScore (m) 

> 10:

B[m] ← (sim m, sa m) 

> 11:

end for  

> 12:

if the size of P0 is greater than s then  

> 13:

P0 ← top s matches from P0 

> 14:

end if  

> 15:

P1 ← P 0 ▷ Initialize next population  

> 16:

while t < N do  

> 17:

for i = 1 to α do ▷ Formula-constrained reproduction  

> 18:

Mg ← P g ▷ Define mating pool  

> 19:

(m1, m 2) ← BinaryTournamentMating (Mg ) ▷ NSGA-II selection  

> 20:

m′ ← Crossover (m1, m 2) 

> 21:

m′ ← Mutation (m′, μ ) 

> 22:

if m′ /∈ B then  

> 23:

Pg+1 ← P g+1 ∪ { m′} 

> 24:

end if  

> 25:

end for  

> 26:

t ← t + |P g+1 \ B| ▷ Increment call counter with num. of new molecules  

> 27:

for m ∈ P g+1 \ B do  

> 28:

ˆsm ← O (m) 

> 29:

sim m, sa m ← EntropySimilarity (ˆ sm, T ), NormSAScore (m) 

> 30:

B[m] ← (sim m, sa m) 

> 31:

end for  

> 32:

▷ Pareto ranking with NSGA-II and selection  

> 33:

R1, R2, . . . R|P g+1 | ← NonDominatedSort (Pg+1 ) ▷ Sort by (sim , sa)  

> 34:

Pg+1 ← SelectK (R1, R2, . . . ; k) ▷ NSGA-II crowding distance to break ties  

> 35:

g ← g + 1  

> 36:

end while  

> 37:

C ← Sort Pg by sim m descending  

> 38:

return C

18 Details of quantitative evaluations 

NIST’20 benchmarking 

For the NIST’20 experiments, we use a version of the ICEBERG model trained on a random (2D InchiKey disjoint) split of the NIST’20 training set, following the same data split as ICEBERG [20]. This dataset features 10 adducts ([M+H] +, [M −H] −,[M −H2O+H] +,[M+Na] +, [M −2H 2O+H] +, [M −H−CO 2]−, [M −H−H2O] −, [M+NH 3

+H] +,[M+Cl] −, [M+K] +), whose training counts can be found in Supplementary Table S2. We therefore only evaluate FOAM’s performance on spectra that belong to the test fold of this split (4,925 test instances) to avoid concerns of data leakage. Searches are run for a maximum of 7,500 calls to ICEBERG. 

Confidence prediction model 

To estimate the probability of FOAM’s elucidation success in prospective settings, we build a binary classifier to predict whether the true molecule will appear in the Top 10 candidate set (“Top 10 Exact Match”). We focus on predicting this outcome at the end of the trajectory (7,500 calls), where approximately 28% of cases have a true molecule in the Top 10. We train a logistic regression model (from the scikit-learn library [64]) on the following features: 1. Adduct type of the spectrum (one-hot encoded; 10 possible adducts) 2. Number of collision energies available for the test structure (range: 1 to 30) 3. Normalized SAScore of the best identified molecule (ranked by spectral similarity) 4. Spectral similarity of the best identified molecule (ranked by spectral similarity) 5. Generation count 6. Number of seed structures For model evaluation, we employ a 5-fold cross-validation strategy on the dataset. The data is partitioned into five subsets; in each iteration, a logistic regression model is trained on 80% of the data and evaluated on the remaining 20% hold-out fold. We standardize all features, Each logistic regression model is trained with binary cross-entropy loss, L1 regularization (C=1.00), and balanced class weighting. For each model, we average the true positive rates across all hold out sets, then compute the Area Under the Receiver Operating Characteristic curve (AUROC) to get an averaged AUROC, which we use as our primary evaluation metric. 

MassSpecGym benchmarking 

We further benchmark on the MassSpecGym dataset [56]. This open-access dataset features 231,104 spectra; we use the provided data split, which emphasizes gener-alizability, as each test structure has at least an MCES (edit distance) of 10 from any training structure. We retrain a version of ICEBERG that respects this same data split, the details of which are found in S1.4.2. For each of the test spectra in the MassSpecGym benchmark, we seed structures with both formula-matches from PubChem (following the same protocol as for NIST’20) and all formula-matched can-didates generated by DiffMS [29]. Up to 100 proposals are sampled from DiffMS for 19 each spectrum. Since DiffMS is heavy-atom-constrained, we filter out any propos-als that do not exactly match the specified chemical formula. We exclude the true structure from the seeds retrieved from PubChem (as identified by first layer InChI match), but retain it if it appears among the DiffMS suggestions. Searches are run for a maximum of 1,500 ICEBERG calls. 

Excluded baseline methods 

Comparisons and potential extensions of some recently released de novo generation models, namely MIST+MolForge [65], Gaia-01 [66], and TTT [67] are excluded as we could not confirm the absence of data leakage in their reported implementation. Given that FOAM successfully improves over DiffMS-generated structures, as shown in Table 1, we expect FOAM to serve as an orthogonal approach to improve any other 

de novo generation methods. 

## Evaluation metrics 

To evaluate our Top 1 and Top 10 candidate sets, which are extracted from all can-didates ranked by spectral similarity only, we use ”Best of 1” to refer to our Top 1 rank structure’s metric, and ”Best of 10” to refer to the best of the top 10 ranked structures’ metrics. 

• Spectral similarity: spectral entropy similarity [53] specsim( T , ˆs) = 1 − 2 H(0 .5( T + ˆ s)) − H(T ) − H(ˆ s)ln(4) (1) 

• Tanimoto similarity: Let F P be our 2048-bit Morgan fingerprint (radius 2) generator from RDKit (version 2023.9.6), then: Tani( m1, m 2) = |F P (m1) ∩ F P (m2)||F P (m1)| + |F P (m2)| − | F P (m1) ∩ F P (m2)| (2) – Best of 1: T (w, m (1) )– Best of 10: max i∈{ 1... 10 } T (w, m (i))where w is the ground truth structure. 

• Exact Match: Given the first layer (connectivity) of 2 InchiKeys (first 14 characters), we measure Exact Match by measuring whether they equal each other: Exact Match( m1, m 2) = (2D InchiKey( m1) == 2D InchiKey( m2)) (3) 

• Maximum common edge subgraph edit distance [68]: MCES( Gm1 , G m2 ) = |Em1 | + |Em2 | − 2|Ec| (4) 

Gc = ( Vc, E c) ⊆ Gm1 , G m2 s.t. |Ec| is maximized (5) 20 – Best of 1: MCES( w, m (1) )– Best of 10: min i∈{ 1... 10 } MCES( w, m (i))

Acknowledgements. We thank Joules Provenzano, Wenhao Gao, Jihye Roh, Babak Mahjour, and Magdalena Lederbauer for assistance and feedback during development. 

# Declarations 

Funding: This work was supported by DSO National Laboratories in Singapore and the MIT Generative AI Impact Consortium (MGAIC). M.M. was supported by NIH grant T32GM087237 and by an NSF Graduate Research Fellowship (grant no. 2141064). 

Conflict of interest: The authors declare no competing interests. 

Ethics approval and consent to participate: Not applicable. 

Code availability: FOAM is open-source; its code, documentation, and analytical scripts can be found at https://github.com/coleygroup/foam. Configuration files are provided, as are the seed structure caches, to reproduce all experiments performed in the paper and to facilitate straightforward modification for its usage in other structural elucidation campaigns. 

Data availability: Code and data are available at https://github.com/ coleygroup/foam. The NIST 2020 dataset is under commercial license and cannot be freely redistributed. The MassSpecGym dataset may be found at https://huggingface.co/datasets/roman-bushuiev/MassSpecGym/. MassSpecGym model weights, as well as PubChem and DiffMS seed structure caches, may be found on Zenodo: doi:10.5281/zenodo.18502041. 

Author contributions: C.W.C., M.M., and S.G. conceptualized the project. M.M., R.W., and J.F. implemented the algorithmic framework. M.M. and R.W. trained models. M.M. ran and analyzed the experiments. All authors contributed to the writing of the manuscript. 

# References 

[1] Dang, L. et al. Cancer-associated IDH1 mutations produce 2-hydroxyglutarate. 

Nature 462 , 739–744 (2009). [2] Watrous, J. et al. Mass spectral molecular networking of living microbial colonies. 

Proc. Natl. Acad. Sci. U. S. A. 109 , E1743–52 (2012). [3] Quinn, R. A. et al. Global chemical effects of the microbiome include new bile-acid conjugations. Nature 579 , 123–129 (2020). [4] Li, V. L. et al. An exercise-inducible metabolite that suppresses feeding and obesity. Nature 606 , 785–790 (2022). [5] Kl¨ unemann, M. et al. Bioaccumulation of therapeutic drugs by human gut bacteria. Nature 597 , 533–538 (2021). 21 [6] Gentry, E. C. et al. Reverse metabolomics for the discovery of chemical structures from humans. Nature 1–3 (2023). [7] Strynar, M. et al. Identification of novel perfluoroalkyl ether carboxylic acids (PFECAs) and sulfonic acids (PFESAs) in natural waters using accurate mass time-of-flight mass spectrometry (TOFMS). Environ. Sci. Technol. 49 , 11622– 11630 (2015). [8] Hollender, J., Schymanski, E. L., Singer, H. P. & Ferguson, P. L. Nontarget screening with high resolution mass spectrometry in the environment: Ready to go? Environ. Sci. Technol. 51 , 11505–11512 (2017). [9] Tian, Z. et al. A ubiquitous tire rubber-derived chemical induces acute mortality in coho salmon. Science 371 , 185–189 (2021). [10] Black, R. M. & Read, R. W. Analysis of degradation products of organophos-phorus chemical warfare agents and related compounds by liquid chromatogra-phy–mass spectrometry using electrospray and atmospheric pressure chemical ionisation. J. Chromatogr. A 794 , 233–244 (1998). [11] Fraga, C. G., Clowers, B. H., Moore, R. J. & Zink, E. M. Signature-discovery approach for sample matching of a nerve-agent precursor using liquid chromatography-mass spectrometry, XCMS, and chemometrics. Anal. Chem. 82 ,4165–4173 (2010). [12] Røen, B. T., Sellev˚ ag, S. R. & Lundanes, E. On-line solid phase extraction-liquid chromatography-mass spectrometry for trace determination of nerve agent degradation products in water samples. Anal. Chim. Acta 761 , 109–116 (2013). [13] Benito, S. et al. Characterization of organic gunshot residues in lead-free ammu-nition using a new sample collection device for liquid chromatography-quadrupole time-of-flight mass spectrometry. Forensic Sci. Int. 246 , 79–85 (2015). [14] Schymanski, E. L. et al. Identifying small molecules via high resolution mass spectrometry: communicating confidence. Environ. Sci. Technol. 48 , 2097–2098 (2014). [15] Stein, S. Mass spectral reference libraries: an ever-expanding resource for chemical identification. Anal. Chem. 84 , 7274–7282 (2012). [16] Wang, M. et al. Sharing and community curation of mass spectrometry data with global natural products social molecular networking. Nat. Biotechnol. 34 ,828–837 (2016). [17] Bittremieux, W., Wang, M. & Dorrestein, P. C. The critical role that spectral libraries play in capturing the metabolomics community knowledge. Metabolomics 

18 , 94 (2022). 22 [18] El Abiead, Y. et al. Discovery of metabolites prevails amid in-source fragmenta-tion. Nat. Metab. 7, 435–437 (2025). [19] Goldman, S., Li, J. & Coley, C. W. Generating molecular fragmentation graphs with autoregressive neural networks. Anal. Chem. 96 , 3419–3428 (2024). [20] Wang, R. et al. Neural spectral prediction for structure elucidation with tandem mass spectrometry. bioRxivorg 2025.05.28.656653 (2025). [21] Wang, F. et al. CFM-ID 4.0: More accurate ESI-MS/MS spectral prediction and compound identification. Anal. Chem. 93 , 11692–11700 (2021). [22] Young, A. et al. FraGNNet: A deep probabilistic model for mass spectrum prediction. arXiv [cs.LG] (2024). [23] Murphy, M. et al. Efficiently predicting high resolution mass spectra with graph neural networks. arXiv [cs.LG] (2023). [24] Ruttkies, C., Schymanski, E. L., Wolf, S., Hollender, J. & Neumann, S. Met-Frag relaunched: incorporating strategies beyond in silico fragmentation. J. Cheminform. 8, 3 (2016). [25] Young, A., Wang, B. & R¨ ost, H. MassFormer: Tandem mass spectrum prediction for small molecules using graph transformers. arXiv [cs.LG] (2021). [26] Wang, R., Wang, R., Manjrekar, M. & Coley, C. W. Neural graph matching improves retrieval augmented generation in molecular machine learning. Forty-second International Conference on Machine Learning (2025). URL https:// openreview.net/forum?id=nx8QhIlZh8. [27] Kim, S. et al. PubChem 2025 update. Nucleic Acids Res. 53 , D1516–D1525 (2025). [28] Stravs, M. A., D¨ uhrkop, K., B¨ ocker, S. & Zamboni, N. MSNovelist: de novo structure generation from mass spectra. Nat. Methods 19 , 865–870 (2022). [29] Bohde, M., Manjrekar, M., Wang, R., Ji, S. & Coley, C. W. Diffms: Diffusion generation of molecules conditioned on mass spectra. Forty-second International Conference on Machine Learning (2025). URL https://openreview.net/forum? id=EvILcv2v8L. [30] Ertl, P. & Schuffenhauer, A. Estimation of synthetic accessibility score of drug-like molecules based on molecular complexity and fragment contributions. J. Cheminform. 1, 8 (2009). [31] Wishart, D. S. et al. HMDB 3.0–the human metabolome database in 2013. Nucleic Acids Res. 41 , D801–7 (2013). 23 [32] Jeffryes, J. G. et al. MINEs: open access databases of computationally predicted enzyme promiscuity products for untargeted metabolomics. J. Cheminform. 7,44 (2015). [33] Djoumbou-Feunang, Y. et al. BioTransformer: a comprehensive computational tool for small molecule metabolism prediction and metabolite identification. J. Cheminform. 11 , 2 (2019). [34] Mahjour, B., Lu, J., Fromer, J., Casetti, N. & Coley, C. Ideation and evalu-ation of novel multicomponent reactions via mechanistic network analysis and automation. ChemRxiv (2024). [35] Lindsay, R. K., Buchanan, B. G., Feigenbaum, E. A. & Lederberg, J. DENDRAL: A case study of the first expert system for scientific hypothesis formation. Artif. Intell. 61 , 209–261 (1993). [36] Meringer, M. & Schymanski, E. L. Small molecule identification with MOLGEN and mass spectrometry. Metabolites 3, 440–462 (2013). [37] Qiang, H. et al. Language model-guided anticipation and discovery of mammalian metabolites. Nature 1–10 (2026). [38] Martin, M. R. & Hassoun, S. Optimized DE novo molecular generation (OMG) for mass spectra annotation using transfer and reinforcement learning. Anal. Chem. (2025). [39] Tang, X. et al. A survey of generative AI for de novo drug design: new frontiers in molecule and protein generation. Brief. Bioinform. 25 , bbae338 (2024). [40] ¨Oz¸ celik, R., Brinkmann, H., Criscuolo, E. & Grisoni, F. Generative deep learning for de novo drug Design-A chemical space odyssey. J. Chem. Inf. Model. 65 ,7352–7372 (2025). [41] Litsa, E., Chenthamarakshan, V., Das, P. & Kavraki, L. Spec2Mol: An end-to-end deep learning framework for translating MS/MS spectra to de-novo molecules. 

ChemRxiv (2021). [42] Butler, T. et al. MS2Mol: A transformer model for illuminating dark chemical space from mass spectra. ChemRxiv (2023). [43] Wang, Y., Chen, X., Liu, L. & Hassoun, S. MADGEN: Mass-spec attends to de novo molecular generation. arXiv [cs.LG] (2025). [44] D¨ uhrkop, K. et al. SIRIUS 4: a rapid tool for turning tandem mass spectra into metabolite structure information. Nat. Methods 16 , 299–302 (2019). [45] Goldman, S. et al. Annotating metabolite mass spectra with domain-inspired chemical formula transformers. Nat. Mach. Intell. 5, 965–979 (2023). 24 [46] Fromer, J. C. & Coley, C. W. Computer-aided multi-objective optimization in small molecule discovery. Patterns (N. Y.) 4, 100678 (2023). [47] Du, Y. et al. Machine learning-aided generative molecular design. Nat. Mach. Intell. 1–16 (2024). [48] Mirza, A. & Jablonka, K. M. Elucidating structures from spectra using multimodal embeddings and discrete optimization (2024). [49] Jin, Y. et al. NMR-solver: Automated structure elucidation via large-scale spec-tral matching and physics-guided fragment optimization. arXiv [physics.chem-ph] 

(2025). [50] Jensen, J. H. A graph-based genetic algorithm and generative model/monte carlo tree search for the exploration of chemical space. Chem. Sci. 10 , 3567–3572 (2019). [51] Goldman, S., Xin, J., Provenzano, J. & Coley, C. W. MIST-CF: Chemical formula inference from tandem mass spectra. J. Chem. Inf. Model. 64 , 2421–2431 (2024). [52] Xing, S., Shen, S., Xu, B., Li, X. & Huan, T. BUDDY: molecular formula discovery via bottom-up MS/MS interrogation. Nat. Methods 20 , 881–890 (2023). [53] Li, Y. et al. Spectral entropy outperforms MS/MS dot product similarity for small-molecule compound identification. Nat. Methods 18 , 1524–1531 (2021). [54] Deb, K., Pratap, A., Agarwal, S. & Meyarivan, T. A fast and elitist multiobjective genetic algorithm: NSGA-II. IEEE Trans. Evol. Comput. 6, 182–197 (2002). [55] NIST standard reference database 1A. https://www.nist.gov/srd/ nist-standard-reference-database-1a (2020). Accessed: 2022-12-3. [56] Bushuiev, R. et al. MassSpecGym: A benchmark for the discovery and identification of molecules. arXiv [q-bio.QM] (2024). [57] Olivecrona, M., Blaschke, T., Engkvist, O. & Chen, H. Molecular de-novo design through deep reinforcement learning. J. Cheminform. 9, 48 (2017). [58] Mathai, N., Stork, C. & Kirchmair, J. BonMOLi` ere: Small-sized libraries of readily purchasable compounds, optimized to produce genuine hits in biological screens across the protein space. Int. J. Mol. Sci. 22 , 7773 (2021). [59] Le, T., Winter, R., No´ e, F. & Clevert, D.-A. Neuraldecipher - reverse-engineering extended-connectivity fingerprints (ECFPs) to their molecular structures. Chem. Sci. 11 , 10378–10389 (2020). [60] Han, Y., Wang, P., Yu, K., Chen, X. & Chen, L. MS-BART: Unified modeling of mass spectra and molecules for structure elucidation. arXiv [cs.LG] (2025). 25 [61] Domingo-Almenara, X. et al. The metlin small molecule dataset for machine learning-based retention time prediction. Nature communications 10 , 5811 (2019). [62] Landrum, G. et al. rdkit/rdkit: Release 2023.09.5 (2024). [63] Gao, W., Fu, T., Sun, J. & Coley, C. W. Sample efficiency matters: A benchmark for practical molecular optimization. Neural Inf Process Syst abs/2206.12411 ,21342–21357 (2022). [64] Pedregosa, F. et al. Scikit-learn: Machine learning in Python. Journal of Machine Learning Research 12 , 2825–2830 (2011). [65] Neo, N. K. N., Jing, L., Preston, N. Y. Z., Serene, K. X. T. & Shen, B. One small step with fingerprints, one giant leap for DE novo molecule generation from mass spectra. arXiv [cs.LG] (2025). [66] Novogaia. Introducing gaia-01: Decoding nature’s molecules. https://www. novogaia.bio/gaia-01 (2025). Accessed: 2025-12-18. [67] Mismetti, L., Alberts, M., Krause, A. & Graziani, M. Test-time tuned language models enable end-to-end DE novo molecular structure generation from MS/MS spectra. arXiv [cs.AI] (2025). [68] Kretschmer, F., Seipp, J., Ludwig, M., Klau, G. W. & B¨ ocker, S. Coverage bias in small molecule machine learning. Nat. Commun. 16 , 1–19 (2025). 26 Extended Data Fig. 1 Additional evaluations of FOAM on the MassSpecGym dataset. (a) His-togram of unique samples collected from DiffMS; 100 (possibly overlapping) samples were collected per spectrum. (b) Distribution of simulated spectral similarity for the true structure for spectra in the MassSpecGym dataset where collision energy (eV) was either already annotated (known) or was missing (missing). (c) Comparison between statistics from DiffMS to FOAM for encounter rate, and count of close matches in the top 1 and top 10 candidate sets as defined by [42]. (d) Comparison of spectral similarity averages and Top 10 match rates for NIST’20 vs MassSpecGym, which are dra-matically lower when the collision energy needed to be imputed. 

27 Supplementary Information for Generative structural elucidation from mass spectra as an iterative optimization problem 

## Mrunali Manjrekar 1, Runzhong Wang 2,3 , Samuel Goldman 1,Jenna C. Fromer 2, Connor W. Coley 2,3* 

> 1

Computational and Systems Biology, Massachusetts Institute of Technology, Cambridge, MA, USA. 

> 2

Department of Chemical Engineering, Massachusetts Institute of Technology, Cambridge, MA, USA. 

> 3

Department of Electrical Engineering and Computer Science, Massachusetts Institute of Technology, Cambridge, MA, USA. *Corresponding author(s). E-mail(s): ccoley@mit.edu;  

> Keywords: LC-MS/MS, Mass spectrometry, Structural elucidation, Genetic algorithms, Molecular optimization

1Contents 

S1 FOAM implementation details 3

S1.1 Seeding cache . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 3S1.2 Crossover and mutation operations . . . . . . . . . . . . . . . . . . . . 3S1.3 Extended benchmarking details . . . . . . . . . . . . . . . . . . . . . . 5S1.3.1 NIST’20 evaluation . . . . . . . . . . . . . . . . . . . . . . . . . 5S1.4 ICEBERG training . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 5S1.4.1 NIST’20 benchmarking details . . . . . . . . . . . . . . . . . . 5S1.4.2 MassSpecGym benchmarking details . . . . . . . . . . . . . . . 5S1.5 Runtime . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 6S1.6 Parameter choice . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 7S1.6.1 NIST evaluation parameters . . . . . . . . . . . . . . . . . . . . 7S1.7 Parameter choice . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 8S1.7.1 MassSpecGym evaluation parameters . . . . . . . . . . . . . . . 8S1.8 Additional evaluations . . . . . . . . . . . . . . . . . . . . . . . . . . . 8S1.8.1 Review of candidate sets after longer generation count (NIST’20) 11 S1.9 MassSpecGym evaluation results . . . . . . . . . . . . . . . . . . . . . 11 2S1 FOAM implementation details 

## S1.1 Seeding cache 

Candidates are collected from a local cache of PubChem as downloaded in January 2024. Chemical formulas were computed for all structures after deduplication across tautomers and stereoisomers. Salts, fragmented structures, and molecules heavier than 1,500 Dalton are excluded from this cache to follow the constraints of ICEBERG. 

## S1.2 Crossover and mutation operations 

We provide visual examples of the crossover and mutation operations applied in Sup-plementary Figure S1. In panel (a), we show non-ring-based crossover between two parents with both formulas of C 16 H12 O3. We show an example of a single-bond break-age found in both parents that yields two fragments per parent, each of which has a corresponding formula-matched fragment in the other parent. That correspondence is used to define the swap; here, the C 9H7O fragments swap places, the bonds are recon-structed to create two new molecules. One of these molecules is chosen at random (50% probability) to be the offspring of this parent. Further, we also illustrate ring crossover, which now focuses on finding and applying the same swap to ring-based bonds. In panel (b), we show examples of mutation operations that we cover. Any mutation can be posed as a swap of connectivity or shift of electrons. The mutation operations we offer include swaps between a hydrogen and a single bond (first row), as well as swaps between double and triple bonds (not pictured); ring breaking or forma-tion (second row); changes in bond orders to two places on the molecule (third row). The ring formation/breaking and bond order changes can also be crossed together, i.e. where a ring forms, an saturation takes place elsewhere on the molecule to accom-modate the freed hydrogens. Additionally, our mutation operations also cover moving a heteroatom (e.g. O, N) around a ring system (fourth row); and swapping multiple single-bonds for one double bond (fifth row). There is also a ring fusion operation that helps unite two closely joined rings into a fused system (not pictured). We group these into 7 different mutation operations; for every offspring selected to mutate (default probability 20%), Supplementary Table S1 details the probabilities associated with each operation. If there are no rings in the molecule to be mutated, the probabilities of operations involving rings (operations 2, 3, 4, 6, 7) are set to 0 and the remaining probabilities are normalized to sum to 1. Similar normalization occurs also if there are no two neighboring rings, which is necessary for the ring fusion operator (operation 7) to be applied. 3Supplementary Fig. S1 Visualization of examples of formula-constrained crossover and mutation. (a) Crossover examples, through cuts made to non-ring bonds (top) or ring-based bonds (bottom). Fragments made must match in chemical formula for crossover to proceed. (b) Overview of possible mutations that preserve formula. 

Number Mutation operator p

1 Bond order upgrade and downgrade 0.14 2 Bond order downgrade, ring formation 0.07 3 Bond order upgrade, ring break 0.07 4 ring formation, ring break 0.16 5 Cut and paste swaps 0.28 6 Heteroatom migration 0.14 7 Ring fusion 0.14 

Supplementary Table S1 Probabilities associated with each mutation operator type. Operations are visualized in . 

4S1.3 Extended benchmarking details 

S1.3.1 NIST’20 evaluation 

For the NIST’20 experiments, we use a model trained on a random (2D InchiKey dis-joint) split of the NIST’20 training set, consisting of 429,751 training spectra covering 20,676 molecules and 53,074 testing spectra covering 2,556 molecules with random seed=1. This follows the same data split as ICEBERG [20] to make sure there is no data leakage; all training details for this model may be found in the corresponding cita-tion. Spectra are separated by molecule and adduct, but grouped by collision energy, which amounts to 4,925 test instances. For each of these test molecules, we take the provided formula and query all seed structures from PubChem, excluding the true molecule. We run each search with a termination criterion of 7,500 calls to ICEBERG. 

## S1.4 ICEBERG training 

S1.4.1 NIST’20 benchmarking details 

Training of ICEBERG on the NIST’20 reference library followed the same protocol as described in ref. [20], where instructions to reproduce the training can be found. We utilize the model trained with random seed=1 and the random split for all NIST’20 experiments in the paper. The NIST’20 reference library dataset we curated covers 530,640 spectra covering 25,541 molecules collected only from Orbitrap instruments.              

> Adduct type # Training spectra [M+H] +214331 [M −H] −89875 [M −H2O+H] +58426 [M+Na] +25582 [M −2H 2O+H] +11396 [M −H−CO 2]−9504 [M −H−H2O] −7720 [M+NH 3+H] +6263 [M+Cl] −6032 [M+K] +622
> Supplementary Table S2 Training spectra counts by adduct type (random split, NIST’20 dataset)

S1.4.2 MassSpecGym benchmarking details 

The MassSpecGym benchmark [56] consists of 231,104 spectra. It is restricted to only cover [M+H] + and [M+Na] + adducts, structures of 1000 Da or less in molecular weight, but features spectra collected from QToF instruments in addition to spec-tra collected from Orbitrap instruments. Therefore, besides the additional instrument type, the coverage of spectra are more limited in scope compared to NIST’20. The 5spectra are sourced from several public repositories, including GNPS, MoNA, and MassBank, and though there is extensive quality preprocessing, their curation from heterogeneous sources makes their quality more variable compared to those in the NIST’20 reference library. For the MassSpecGym dataset, each spectrum collected at a separate collision energy must be considered independently, amounting to 17,082 testing instances. As consistent with DiffMS, we excluded 65 instances that include elements that are not supported by DiffMS, prohibiting sample generation for experiments. 

Training ICEBERG : As there are both Orbitrap and QToF spectra present in the dataset, we first modify ICEBERG to support an instrument parameter in addition to adduct and collision energy. Approximately half (47%) of this dataset does not include annotated collision energy, which could suggest they may be a combination of spectra run at several collision energies. Nonetheless, to overcome this limitation for compatibility with ICEBERG, which is collision-energy aware, we use the ICEBERG model trained on the NIST’20 Orbitrap data to annotate collision energy for the unannotated spectra. We do so by performing a retrieval sweep over a range of 0-150 eV collision energy and selecting the energy with the lowest entropy distance to the experimental spectra. Inference for this task comprised 2.5 million fragmentations, which took approximately two weeks to run on 3 NVIDIA A5000 GPUs. This step only provides pseudo-annotations of collision energies and does not introduce other knowledge learned from the NIST dataset; the concern of data leakage is minimal. We then use these imputed collision energies to complete the training set, and train a new ICEBERG-Generate model and a ICEBERG-Score model. We train the ICEBERG-Score model with a spectral cosine loss instead of a spectral entropy loss as used by the NIST’20 ICEBERG setting. The weights for this model are available here: doi:10.5281/zenodo.18502041. 

DiffMS as a source of seed structures : To collect DiffMS samples, 100 samples were collected for each of the spectra in the MassSpecGym dataset and deduplicated. Code and weights are used as released here: https://github.com/coleygroup/DiffMS. Any fragmented structures are removed from the samples. Since DiffMS is heavy-atom constrained, samples may have an inconsistent number of hydrogens; only structures that match in the full formula are kept. If the true structure is present in these samples, it is not removed. Collecting all structure samples took approximately one week on 6 NVIDIA H100 GPUs. 

## S1.5 Runtime 

For the NIST’20 experiments, 3 generations (approximately equivalent to 800 calls) takes 4 minutes per test instance; the full search (7,500 calls) takes approximately 20 minutes on average to complete. The spectrum simulation component of the method is GPU-compatible. To accelerate both generation and spectrum simulation, experi-ments were performed on 72-core CPU nodes that dispatched spectrum simulation of ICEBERG to another, GPU-rich node (NVIDIA H200, H100, or 2080Ti GPUs). We adopt a similar strategy for the MassSpecGym experiments, whose full searches (1,500 calls) take on average 3 minutes to run. As a reference point, on an NVIDIA H100 6GPU, ICEBERG can score 500 molecules with coverage of 3 collision energies in 30 seconds. 

## S1.6 Parameter choice 

S1.6.1 NIST evaluation parameters 

Parameter Parameter description Parameter value Oracle call cap Number of allowed calls to ICEBERG before FOAM terminates 7,500 Offspring size Number of maximal new candidates generated at each iteration 600 Population size Size of candidate pool following non-dominated selection 200 Maximum crossover attempts Number of times crossover is attempted before failing 10 Mutation rate Rate of mutation to offspring made following crossover 0.20 Truncation upper min-ima threshold Similarity threshold above which if a sufficient number of molecules are present in the population, truncation will occur 0.4 Truncation percent required Percentage of molecules that must be above the upper minima threshold for truncation to occur 0.20 Truncation cutoff threshold Similarity below which any molecules are removed from the population if truncation occurs 0.35 ICEBERG batch size Number of inputs (each SMILES, duplicated by collision energy) passed to ICEBERG 32 Number of ICEBERG workers Copies of ICEBERG loaded onto asingle 32GB GPU for add’l parallelism 87S1.7 Parameter choice 

S1.7.1 MassSpecGym evaluation parameters 

Parameter Parameter description Parameter value Oracle call cap Number of allowed calls to ICEBERG before FOAM terminates 1,500 Offspring size Number of maximal new candidates generated at each iteration 600 Population size Size of candidate pool following non-dominated selection 200 Maximum crossover attempts Number of times crossover is attempted before failing 10 Mutation rate Rate of mutation to offspring made following crossover 0.20 Truncation upper min-ima threshold Similarity threshold above which if a sufficient number of molecules are present in the population, truncation will occur 0.4 Truncation percent required Percentage of molecules that must be above the upper minima threshold for truncation to occur 0.20 Truncation cutoff threshold Similarity below which any molecules are removed from the population if truncation occurs 0.35 ICEBERG batch size Number of inputs (each SMILES, duplicated by collision energy) passed to ICEBERG 32 Number of ICEBERG workers Copies of ICEBERG loaded onto asingle 32GB GPU for add’l parallelism 8Number of DiffMS samples collected Number of initial seed structure proposals collected from DiffMS (spectrum-conditioned generation) 100 

## S1.8 Additional evaluations 

Beyond the evaluations provided, we additionally track the generative dynamics of FOAM’s searches on the NIST’20 test set. In S2a, we first track what percentage of examples encounter a molecule with equal or higher predicted spectral similarity to the experimental spectrum than that of the true molecule. This plot highlights that by the end of the searches, only 4.8% of searches have not yet encountered a decoy structure with equivalent or higher structural similarity. In S2b, we show where the true molecule, whether present or not, would be dominated by the existing population (i.e, if FOAM were to produce the true molecule, the true molecule would have a Pareto rank greater than 1). This curve plateaus at around 70%, suggesting that about 30% of the instances have produced final populations where the true molecule would still be 8considered Pareto optimal. In S2c and d, we utilize the Close Match and Meaningful Match definitions from [42] to review how relevant our structures might be valuable to domain experts. Using RDKit topological fingerprints, suggestions are considered close matches if they have a Tanimoto similarity of 0.675 or higher, and meaningful matches if they have a Tanimoto similarity of 0.4 or higher. 

Supplementary Fig. S2 Additional evaluation of FOAM performance over time on NIST’20. (a) Proportion of experiments with no decoys observed, over course of trajectory. (b) Whether true structure would be dominated by population. (c) Following analytical chemist defined estimations of structural utility [42], Close match proportions in the top 1 and top 10 candidate sets, as well as (d) Meaningful match proportions in the top 1 and top 10 candidate sets. 

9Supplementary Fig. S3 Distribution of count of seed structures from PubChem and mass versus average encounter rate observed for test spectra in the NIST’20 dataset. 

Supplementary Fig. S4 ICEBERG accuracy and structural similarity (T.S.: Tanimoto similarity) of the Best of 1 and Best of 10 structures, grouped by adduct. Test spectra counts for each adduct are denoted with each x-axis tick label. 

10 S1.8.1 Review of candidate sets after longer generation count (NIST’20)  

> Supplementary Fig. S5 (a) Distribution of structural similarities of best candidates in the top 10 versus predicted spectral similarity to the experimental spectrum for the true structure (x-axis) and closest seed’s structural similarity (y-axis), but after FOAM has run for 25 generations instead of 3 as in Figure 3a. As such, this heatmap displays markedly right-shifted saturation, reflecting the ultimate importance of having an accurate objective measure.

## S1.9 MassSpecGym evaluation results 

One clear differentiating factor within the MassSpecGym dataset is that almost half of the spectra are missing a collision energy annotation, indicating possibly merged spectra or some other modification to the data. On these affected spectra, the predicted spectral similarity of the true molecules associated with these spectra are on average considerably lower (0.193) than that of the spectra with known collision energies, either in the MassSpecGym (0.427) or NIST’20 datasets (0.648) (Extended Data Figure 1d). This translates to a poorer ability to rank the true molecule in the top 10, with FOAM only being able to find a match in the top 10 4.7% of the time, compared to 14.0% on the unaffected MassSpecGym spectra (Extended Data Figure 1d). Additionally, with successive iterations, this less accurate simulator ranks progressively more decoy structures, which have higher simulated spectral similarity but seem to lose structural similarity to the true structure. 11